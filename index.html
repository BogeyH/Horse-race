<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Photo Finish â€” Horse Race Multiplayer Betting</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --navy:#0B1F2A;--cream:#FDF5D9;--red:#D43D3D;--ink:#EDE6CB;--muted:#C8BEA0;--card:#102636;--track:#0E2230;
    --horse-w:44px;                 /* icon width */
    --lane-w:calc(var(--horse-w)*1.5); /* requested lane width = 1.5x icon */
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--navy);color:var(--ink);font-family:"Space Grotesk",system-ui,Arial,sans-serif}
  h1,h2,h3{margin:0 0 .5rem}
  .wrap{max-width:940px;margin:0 auto;padding:16px 16px 80px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid #1e3a4a;border-radius:14px;padding:14px}
  .cta{background:var(--red);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700}
  .cta[disabled]{opacity:.5}
  .ghost{background:transparent;border:1px solid var(--muted);color:var(--ink);border-radius:12px;padding:10px 14px}
  .pill{background:#123042;color:var(--ink);border:1px solid #22465b;border-radius:999px;padding:6px 10px;font-size:.9rem}
  .label{font-size:.85rem;color:var(--muted)}
  .input{width:100%;background:#0d2230;color:#EDE6CB;border:1px solid #254b61;border-radius:10px;padding:10px}
  .kpi{display:flex;align-items:center;justify-content:space-between;background:#0f2636;border:1px solid #22465b;border-radius:12px;padding:10px 12px}
  .badge{padding:4px 8px;border-radius:8px;background:#173448;font-size:.85rem}
  .money{font-weight:700;color:#FFE8A3}
  .small{font-size:.9rem;color:#97adbb}
  .hidden{display:none!important}
  .list{list-style:none;padding:0;margin:0}
  .list li{padding:8px 0;border-bottom:1px solid #183244}
  .list li:last-child{border-bottom:none}

  /* Race */
  .race-shell{position:relative;height:72vh;min-height:460px;border-radius:16px;overflow:hidden;background:linear-gradient(#0B1F2A 0 30%,#0A1D2A 30% 100%);border:1px solid #1f3d50}
  .track{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;padding:0 8px 64px}
  .lanesViewport{position:relative;margin:0 auto;width:min(720px,100%);height:100%;overflow:hidden}
  .lanesWorld{position:absolute;inset:0;will-change:transform}
  .bg{position:absolute;inset:0;background:
      repeating-linear-gradient(180deg,transparent 0 58px,#254a5f 58px 59px),
      linear-gradient(var(--track),var(--track));border:1px solid #284b5e;border-radius:14px}
  .finishLine{position:absolute;left:8px;right:8px;height:10px;background:repeating-linear-gradient(90deg,#eee 0 18px,#111 18px 36px);border:1px solid #223f51;border-left:none;border-right:none}
  .split{position:absolute;left:8px;right:8px;height:2px;background:#1f3f52;opacity:.5}
  .split label{position:absolute;right:6px;top:-10px;font-size:.75rem;color:#93b7c9}
  .gate{position:absolute;left:8px;right:8px;height:14px;background:repeating-linear-gradient(90deg,#eee 0 18px,#111 18px 36px);border-bottom:1px solid #223f51;transform-origin:top;transform:scaleY(1);transition:transform .35s ease}
  .gate.open{transform:scaleY(0)}
  .laneGuides{position:absolute;top:0;bottom:0;left:0;right:0;pointer-events:none}
  .laneGuides .guide{position:absolute;top:0;bottom:0;width:1px;background:#2a4c60;opacity:.5}

  .horse{position:absolute;display:flex;align-items:center;gap:8px;transform:translate(0,0)}
  .silhouette{width:var(--horse-w);height:32px;border-radius:6px;box-shadow:0 0 0 2px rgba(0,0,0,.25) inset}
  .horseTag{background:#0f2a3a;border:1px solid #2b4d60;color:#EDE6CB;padding:6px 8px;border-radius:10px;font-weight:600;white-space:nowrap;display:flex;align-items:center;gap:8px}
  .posBadge{min-width:34px;text-align:center;border-radius:8px;background:#173448;border:1px solid #31576a;padding:2px 6px;font-weight:700}
  .icons{display:flex;align-items:center;gap:4px}
  .icon{width:16px;height:16px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.65rem;color:#0e1b23;font-weight:800}
  .leader{filter:drop-shadow(0 0 10px rgba(212,61,61,.6))}
  .top2 .horseTag{border-color:#d0be6b}
  .top1 .horseTag{border-color:#ffd46b}
  .top3 .horseTag{border-color:#9bd4ff}
  .ticker{position:absolute;top:12px;left:12px;right:12px;display:flex;gap:8px;flex-wrap:wrap}
  .ticker .chip{background:#0e2b3f;border:1px solid #2a4c60;border-radius:999px;padding:6px 10px;font-size:.9rem}

  /* Countdown overlay */
  .countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:5;pointer-events:none;
    background:radial-gradient( circle at 50% 45%, rgba(10,25,35,.45), rgba(10,25,35,.75) 60%, rgba(10,25,35,.9) 100%);}
  .countNum{font-size:12vmin;font-weight:800;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .countGo{font-size:9vmin;color:#FFE8A3}

  @media (min-width:720px){
    .wrap{padding:20px 20px 88px}
    .silhouette{height:36px}
  }

  /* Odds + stats in selection */
  .odds{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .odds .chip{background:#123043;border:1px solid #274c5f;border-radius:999px;padding:6px 10px}
  .statRow{display:flex;gap:8px;align-items:center;margin-top:6px}
  .statLabel{width:64px;font-size:.8rem;color:#c6d4de}
  .bar{flex:1;height:8px;background:#183647;border:1px solid #2a4c60;border-radius:6px;overflow:hidden}
  .bar>span{display:block;height:100%;background:#70d6ff}
  .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:.85rem;color:#a9c0cd}
  .legend .key{display:flex;gap:6px;align-items:center}
  .legend .swatch{width:14px;height:8px;border-radius:3px}
  .lg-speed{background:#70d6ff}
  .lg-stamina{background:#ffd46b}
  .lg-burst{background:#ff9bb5}
</style>
</head>
<body>
<div class="wrap">
  <header class="row" style="align-items:center;justify-content:space-between">
    <h1>Photo Finish</h1>
    <div class="pill">20s race â€¢ Local Multiplayer</div>
  </header>

  <!-- Players -->
  <section id="screen-players" class="grid">
    <div class="card grid" style="gap:12px">
      <h2>Add Players</h2>
      <div class="row">
        <div class="kpi" style="flex:1">
          <div><div class="label">Starting Balance</div><div class="money" id="startMoneyShow">1000</div></div>
          <input id="startMoney" class="input" type="number" min="100" step="50" value="1000" style="max-width:160px">
        </div>
      </div>
      <div class="row"><input id="playerName" class="input" placeholder="Player name" style="flex:1"><button id="addPlayer" class="cta">Add</button></div>
      <div class="row"><button class="ghost quick" data-n="2">Quick add 2</button><button class="ghost quick" data-n="3">3</button><button class="ghost quick" data-n="4">4</button><button class="ghost quick" data-n="5">5</button><button class="ghost quick" data-n="6">6</button></div>
      <ul id="playerList" class="list"></ul>
      <div class="row"><button id="startGame" class="cta" disabled>Start Game</button><button id="resetAll" class="ghost">Reset</button></div>
    </div>
  </section>

  <!-- Selection -->
  <section id="screen-select" class="grid hidden">
    <div class="card grid" style="gap:10px">
      <h2>Horse Selection</h2>
      <div id="turnBanner" class="kpi">
        <div><div class="label">Now selecting</div><div id="currentPlayerName" style="font-weight:700"></div></div>
        <div class="money">Balance: <span id="currentPlayerBalance">0</span></div>
      </div>
      <div class="legend">
        <div class="key"><span class="swatch lg-speed"></span>Speed: base pace</div>
        <div class="key"><span class="swatch lg-stamina"></span>Stamina: mid-race hold</div>
        <div class="key"><span class="swatch lg-burst"></span>Burst: late kick</div>
      </div>
    </div>

    <div class="card grid" style="gap:10px">
      <h3>Horses</h3>
      <div id="horseGrid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px"></div>
    </div>

    <div class="card grid" style="gap:10px">
      <h3>Bet</h3>
      <div class="row">
        <select id="betType" class="input" style="max-width:180px"><option value="win">Win</option><option value="place">Place (Top 3)</option></select>
        <input id="betAmount" class="input" type="number" min="1" step="10" value="50" style="max-width:160px">
        <button id="lockPick" class="cta" style="flex:1" disabled>Lock Pick</button>
      </div>
      <div id="pickPreview" class="small"></div>
    </div>

    <div class="card">
      <h3>Summary</h3>
      <ul id="pickList" class="list"></ul>
      <div class="row"><button id="beginRace" class="cta" disabled>Start Race</button><button id="backToPlayers" class="ghost">Back</button></div>
    </div>
  </section>

  <!-- Race -->
  <section id="screen-race" class="grid hidden">
    <div class="card"><h2>Race</h2><div class="small">20 seconds â€¢ Top to bottom â€¢ Leader camera</div></div>
    <div class="race-shell">
      <div class="ticker" id="raceTicker"></div>
      <div class="track">
        <div class="lanesViewport" id="lanesViewport">
          <div class="lanesWorld" id="lanesWorld">
            <div class="bg" id="bg"></div>
            <div class="laneGuides" id="laneGuides"></div>
            <div id="finishLine" class="finishLine"></div>
            <div id="splitMarks"></div>
            <div id="gate" class="gate"></div>
            <!-- horse sprites appended here -->
          </div>
          <div class="countdown hidden" id="countdown"><div id="countNum" class="countNum">3</div></div>
        </div>
      </div>
    </div>
    <div class="row" style="position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(11,31,42,0),rgba(11,31,42,.95));padding:8px 12px 16px">
      <div style="max-width:940px;margin:0 auto;display:flex;gap:8px;width:100%"><button id="skipToResults" class="ghost" style="flex:1">Skip animation</button></div>
    </div>
  </section>

  <!-- Results -->
  <section id="screen-results" class="grid hidden">
    <div class="card grid" style="gap:8px"><h2>Results</h2><div id="podium" class="row"></div></div>
    <div class="card"><h3>Final Order</h3><ul id="orderList" class="list"></ul></div>
    <div class="card"><h3>Player Outcomes</h3><ul id="playerOutcomes" class="list"></ul></div>
    <div class="row"><button id="nextRound" class="cta">Next Race</button><button id="leavePlayers" class="ghost">Remove Leavers</button><button id="fullReset" class="ghost">Reset Game</button></div>
  </section>
</div>

<script>
(function(){
  // ----- Real horse names (200) â€” same list you approved
  const REAL_NAMES=[ "Secretariat","Man oâ€™ War","Seabiscuit","Citation","War Admiral","Affirmed","Alydar","Spectacular Bid","Sunday Silence","Easy Goer","Northern Dancer","Ruffian","Zenyatta","Black Caviar","Frankel","American Pharoah","Justify","Flightline","Arrogate","Curlin","Ghostzapper","Gun Runner","California Chrome","Winx","Phar Lap","Omaha","Whirlaway","Count Fleet","Gallant Fox","Native Dancer","Bold Ruler","Nashua","Kelso","Buckpasser","Forego","John Henry","Damascus","Dr. Fager","Alysheba","Cigar","Invasor","Peintre Celebre","Dancing Brave","Dubai Millennium","Sea The Stars","Galileo","Montjeu","Deep Impact","Harbinger","Enable","Tiger Roll","Red Rum","Desert Orchid","Kauto Star","Sprinter Sacre","Denman","Big Brown","Smarty Jones","Funny Cide","Barbaro","Rags to Riches","Ladyâ€™s Secret","Winning Colors","Genuine Risk","Serenaâ€™s Song","Personal Ensign","Beholder","Monomoy Girl","Rachel Alexandra","Havre de Grace","Blind Luck","Songbird","Tepin","Goldikova","Treve","Miesque","Dahlia","Ouija Board","Fantastic Light","Highland Reel","Crystal Ocean","Poetâ€™s Word","Desert Crown","Hurricane Run","Almanzor","Sottsass","Vadeni","Paddington","Ace Impact","City of Troy","Auguste Rodin","Baaeed","Palace Pier","Pinatubo","Too Darn Hot","Blue Point","Lord Kanaloa","Lys Gracieux","Chrono Genesis","Almond Eye","Drefong","Nature Strip","Anamoe","Giga Kick","I Wish I Win","Verry Elleegant","Incentivise","Romantic Warrior","Golden Sixty","Beauty Generation","Able Friend","Silent Witness","Sacred Kingdom","Fairy King Prawn","Lucky Sweynesse","Wellington","Lucky Nine","Pakistan Star","Aerovelocity","Danon Smash","Satono Crown","Kizuna","Real Steel","Victoire Pisa","Just A Way","Orfevre","Buena Vista","Vodka","Daiwa Scarlet","Admire Moon","Heartâ€™s Cry","King Kamehameha","El Condor Pasa","Agnes World","Agnes Digital","Eishin Preston","Stay Gold","Duramente","Contrail","Daring Tact","Loves Only You","Titleholder","Equinox","Liberty Island","Do Deuce","Stars on Earth","Songline","Schnell Meister","Gran Alegria","Indy Champ","Maurice","Harp Star","Gentildonna","Gold Ship","Epiphaneia","Le Vent Se Leve","Chuwa Wizard","T O Keynes","Ushba Tesoro","Panthalassa","Cafe Pharoah","Yoshida","Mind Your Biscuits","Lava Man","Game On Dude","Mucho Macho Man","Paynter","Bayern","Frosted","Honor Code","Tonalist","Palace Malice","Will Take Charge","Shackleford","Dullahan","Hansen","Union Rags","Orb","Palace Episode","Street Sense","Hard Spun","Any Given Saturday","Lawyer Ron","Quality Road","Animal Kingdom","Gio Ponti","Big Drama","Blame","Summer Bird","Mine That Bird","Daâ€™ Tara","Proud Spell","Eight Belles","Dialed In","Always Dreaming","Tapwrit","Essential Quality","Epicenter","Forte","Goldikova II" ];

  // ----- State
  const state={
    players:[], startBalance:1000, round:1, order:[], horses:[], picks:[],
    race:{
      duration:20000, trackDistance:3200, runoff:100,
      t0:0, raf:0, finished:false, results:[], sprites:[],
      worldHeight:0, padTop:24, padBot:24, rankCounter:1, started:false
    }
  };

  // ----- Helpers
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const fmt=n=>Number(n).toLocaleString(), rnd=(a,b)=>Math.random()*(b-a)+a, rndi=(a,b)=>Math.floor(rnd(a,b+1));
  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
  const byId=id=>state.players.find(p=>p.id===id);
  const pct=v=>Math.round(clamp(v,0,1)*100);
  function randn(mu=0,s=1){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);return mu+z*s}
  function esc(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=rndi(0,i);[a[i],a[j]]=[a[j],a[i]]}return a}
  function groupBy(a,k){return a.reduce((m,o)=>((m[o[k]]??=[]).push(o),m),{})}
  function sampleNamesFromList(n){const pool=[...REAL_NAMES], out=[]; while(out.length<n && pool.length){ out.push(...pool.splice(rndi(0,pool.length-1),1)); } return out.slice(0,n); }
  const ordinal=n=>n===1?'1st':n===2?'2nd':n===3?'3rd':`${n}th`;
  const initials=name=>name.split(/\s+/).map(w=>w[0]||'').join('').slice(0,2).toUpperCase();
  const colorFromStr=s=>{let h=0;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0;return `hsl(${h%360} 70% 60%)`;};

  // ----- Screens
  const screens={players:$('#screen-players'),select:$('#screen-select'),race:$('#screen-race'),results:$('#screen-results')};
  function show(k){Object.values(screens).forEach(s=>s.classList.add('hidden'));screens[k].classList.remove('hidden');}

  // ----- Players
  const startMoney=$('#startMoney'),startMoneyShow=$('#startMoneyShow'),playerName=$('#playerName'),playerList=$('#playerList');
  $('#resetAll').onclick=fullReset;
  $('#addPlayer').onclick=()=>{const n=playerName.value.trim();if(!n)return;addPlayer(n);playerName.value='';renderPlayers();}
  $$('.quick').forEach(b=>b.onclick=()=>{const N=+b.dataset.n,base=["Alex","Sam","Casey","Jordan","Taylor","Riley","Jamie","Drew","Quinn","Harper"];while(state.players.length<N){addPlayer(base[state.players.length%base.length]+(state.players.length>=base.length?(" "+(state.players.length+1)):""));}renderPlayers();});
  startMoney.oninput=()=>{const v=Math.max(100,+startMoney.value||1000);state.startBalance=v;startMoneyShow.textContent=fmt(v);};
  function addPlayer(name){if(state.players.length>=6)return;state.players.push({id:crypto.randomUUID(),name,balance:state.startBalance,active:true});}
  function removePlayer(id){state.players=state.players.filter(p=>p.id!==id);}
  function renderPlayers(){
    playerList.innerHTML='';
    state.players.forEach(p=>{
      const li=document.createElement('li');
      li.innerHTML=`<div class="row" style="align-items:center;justify-content:space-between">
        <div><strong>${esc(p.name)}</strong> <span class="badge">Balance: <span class="money">${fmt(p.balance)}</span></span></div>
        <div class="row"><button class="ghost" data-id="${p.id}">Remove</button></div>
      </div>`;
      playerList.appendChild(li);
    });
    $$('#playerList button').forEach(b=>b.onclick=()=>{removePlayer(b.dataset.id);renderPlayers();});
    $('#startGame').disabled=state.players.length<2;
  }
  $('#startGame').onclick=()=>{state.round=1;startRound();}; renderPlayers();

  // ----- Selection
  const turnBanner=$('#turnBanner'),currentPlayerName=$('#currentPlayerName'),currentPlayerBalance=$('#currentPlayerBalance');
  const horseGrid=$('#horseGrid'),pickList=$('#pickList'),betType=$('#betType'),betAmount=$('#betAmount'),lockPick=$('#lockPick');
  const beginRace=$('#beginRace'),pickPreview=$('#pickPreview'); $('#backToPlayers').onclick=()=>show('players');

  function startRound(){
    state.picks=[]; state.order=shuffle(state.players.filter(p=>p.active).map(p=>p.id));
    state.horses=genHorses(6); state.race.finished=false; state.race.results=[]; state.race.rankCounter=1; state.race.started=false;
    renderSelect(); show('select'); idx=0; prepTurn();
  }
  function genHorses(n){
    const colors=Array.from({length:n},(_,i)=>`hsl(${Math.round(i*360/n)} 70% 55%)`);
    const names=sampleNamesFromList(n);
    return Array.from({length:n},(_,i)=>{
      const speed=clamp(randn(0.65,0.15),0.35,1), stamina=clamp(randn(0.65,0.15),0.35,1), burst=clamp(randn(0.65,0.15),0.35,1);
      const q=speed*0.5+stamina*0.3+burst*0.2, base=rnd(19.2,21.5)-(q-0.65)*2.0, ft=clamp(base,18.8,22.5)*1000;
      const win=clamp(1.6+(1-q)*2.4+rnd(0,0.4),1.4,4.6), plc=clamp(win*rnd(0.5,0.7),1.2,Math.max(1.2,win*0.85));
      return {id:crypto.randomUUID(),name:names[i],color:colors[i],stats:{speed,stamina,burst,q},finishTime:ft,odds:{win,place:plc}};
    });
  }

  function renderSelect(){
    horseGrid.innerHTML='';
    state.horses.forEach(h=>{
      const c=document.createElement('div'); c.className='card'; c.style.cursor='pointer'; c.dataset.hid=h.id;
      c.innerHTML=`
        <div class="row" style="align-items:flex-start;justify-content:space-between">
          <div class="row" style="align-items:flex-start;gap:10px">
            <div class="silhouette" style="background:${h.color}"></div>
            <div>
              <div style="font-weight:700">${esc(h.name)}</div>
              <div class="statRow"><div class="statLabel">Speed</div><div class="bar"><span style="width:${pct(h.stats.speed)}%"></span></div></div>
              <div class="statRow"><div class="statLabel">Stamina</div><div class="bar"><span style="width:${pct(h.stats.stamina)}%;background:#ffd46b"></span></div></div>
              <div class="statRow"><div class="statLabel">Burst</div><div class="bar"><span style="width:${pct(h.stats.burst)}%;background:#ff9bb5"></span></div></div>
              <div class="odds"><span class="chip">Win <strong>${h.odds.win.toFixed(2)}x</strong></span><span class="chip">Place <strong>${h.odds.place.toFixed(2)}x</strong></span></div>
            </div>
          </div>
        </div>`;
      c.onclick=()=>selectHorse(h.id);
      horseGrid.appendChild(c);
    });
    renderPicks();
  }

  let idx=0, selHorse=null;
  function prepTurn(){
    if(idx>=state.order.length){beginRace.disabled=false;turnBanner.classList.add('hidden');return;}
    beginRace.disabled=true;turnBanner.classList.remove('hidden');selHorse=null;lockPick.disabled=true;
    const pid=state.order[idx], p=byId(pid);
    currentPlayerName.textContent=p.name; currentPlayerBalance.textContent=fmt(p.balance);
    betAmount.value=Math.min(100,p.balance); pickPreview.textContent='';
    $$('#horseGrid .card').forEach(e=>e.style.outline='1px solid #1e3a4a');
  }
  function selectHorse(id){selHorse=id; $$('#horseGrid .card').forEach(e=>e.style.outline=e.dataset.hid===id?'2px solid var(--red)':'1px solid #1e3a4a'); updatePreview();}
  function updatePreview(){
    const pid=state.order[idx], p=byId(pid), amt=clamp(+betAmount.value||0,1,p.balance); betAmount.value=amt;
    if(!selHorse){lockPick.disabled=true; pickPreview.textContent=''; return;}
    const h=state.horses.find(x=>x.id===selHorse), t=betType.value, m=t==='win'?h.odds.win:h.odds.place;
    pickPreview.textContent=`${p.name} â†’ ${h.name} â€¢ ${t.toUpperCase()} â€¢ ${fmt(amt)} @ ${m.toFixed(2)}x`;
    lockPick.disabled=false;
  }
  betType.onchange=updatePreview; betAmount.oninput=updatePreview;
  lockPick.onclick=()=>{const pid=state.order[idx], p=byId(pid), amt=clamp(+betAmount.value||0,1,p.balance); if(!selHorse||amt<1) return;
    state.picks.push({playerId:p.id,horseId:selHorse,type:betType.value,amount:amt}); p.balance-=amt; idx++; renderPicks(); prepTurn();};
  function renderPicks(){
    pickList.innerHTML='';
    state.order.forEach(pid=>{
      const p=byId(pid), pick=state.picks.find(x=>x.playerId===pid), li=document.createElement('li');
      li.innerHTML = pick
        ? `<strong>${esc(p.name)}</strong> â†’ <span class="pill">${esc(state.horses.find(x=>x.id===pick.horseId).name)}</span> â€¢ <span class="badge">${pick.type.toUpperCase()}</span> â€¢ <span class="money">${fmt(pick.amount)}</span>`
        : `<strong>${esc(p.name)}</strong> is choosingâ€¦`;
      pickList.appendChild(li);
    });
  }

  $('#beginRace').onclick=()=>{setupRace();show('race');beginCountdownThenStart();};
  $('#skipToResults').onclick=()=>endRace(true);

  // ----- Race scene
  const lanesViewport=$('#lanesViewport'), lanesWorld=$('#lanesWorld'), finishEl=$('#finishLine'),
        splitMarks=$('#splitMarks'), gateEl=$('#gate'), bg=$('#bg'), raceTicker=$('#raceTicker'),
        laneGuides=$('#laneGuides'), countdownEl=$('#countdown'), countNum=$('#countNum');

  function setupRace(){
    lanesWorld.innerHTML=''; lanesWorld.append(bg,laneGuides,finishEl,splitMarks,gateEl); raceTicker.innerHTML='';
    const TD=state.race.trackDistance, padTop=24, padBot=24;
    const worldH=TD+padTop+padBot; state.race.worldHeight=worldH; state.race.padTop=padTop; state.race.padBot=padBot;

    lanesWorld.style.height=worldH+'px'; bg.style.height=worldH+'px';
    gateEl.style.top=padTop+'px'; finishEl.style.bottom=padBot+'px';

    // Vertical splits
    splitMarks.innerHTML='';
    [0.25,0.5,0.75].forEach(f=>{const y=padTop + TD*f; const s=document.createElement('div'); s.className='split'; s.style.top=y+'px'; const lab=document.createElement('label'); lab.textContent=Math.round(f*100)+'%'; s.appendChild(lab); splitMarks.appendChild(s);});

    // Lane guides (6 lanes)
    laneGuides.innerHTML='';
    const leftPad=14;
    for(let i=0;i<6;i++){
      const x=leftPad + i*parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lane-w'));
      const g=document.createElement('div'); g.className='guide'; g.style.left=(x+parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lane-w'))-1)+'px';
      laneGuides.appendChild(g);
    }

    // Sprites at the gate (top) â€” one per lane, left-to-right
    const laneW=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lane-w'));
    state.race.sprites = state.horses.map((h,i)=>{
      const el=document.createElement('div'); el.className='horse'; el.dataset.hid=h.id;
      const left=leftPad + i*laneW;
      el.style.left=left+'px'; el.style.top=padTop+'px';
      el.style.transform=`translate(0,0)`;

      // body + race label (pos + name + player icons)
      const body=document.createElement('div'); body.className='silhouette'; body.style.background=h.color; body.style.width='var(--horse-w)';
      const tag=document.createElement('div'); tag.className='horseTag'; tag.innerHTML=`<span class="posBadge" data-pos>â€”</span><span class="hName">${esc(h.name)}</span><span class="icons" data-icons></span>`;
      el.append(body,tag); lanesWorld.appendChild(el);
      return {h,el,y:0,vBase:TD/(h.finishTime/1000),plan:pacePlan(h),crossed:false,offtrack:false,crossTime:null,rank:null,tag,icons:tag.querySelector('[data-icons]'),posEl:tag.querySelector('[data-pos]')};
    });

    // Ticker
    state.horses.forEach(h=>{const c=document.createElement('div'); c.className='chip'; c.innerHTML=`<span class="silhouette" style="display:inline-block;width:14px;height:10px;border-radius:3px;background:${h.color};margin-right:6px"></span>${esc(h.name)} â€¢ Win <strong>${h.odds.win.toFixed(2)}x</strong> â€¢ Place <strong>${h.odds.place.toFixed(2)}x</strong>`; raceTicker.appendChild(c);});

    // Player icons per horse (initials, color from player name)
    const byHorse = groupBy(state.picks,'horseId');
    state.race.sprites.forEach(S=>{
      S.icons.innerHTML='';
      const arr=byHorse[S.h.id]||[];
      arr.slice(0,4).forEach(pk=>{
        const p=byId(pk.playerId); const ic=document.createElement('span'); ic.className='icon'; ic.textContent=initials(p.name);
        ic.style.background=colorFromStr(p.name); S.icons.appendChild(ic);
      });
      if(arr.length>4){
        const more=document.createElement('span'); more.className='icon'; more.textContent=`+${arr.length-4}`; more.style.background='#b9d3e0';
        S.icons.appendChild(more);
      }
    });
  }

  function pacePlan(h){
    const T=h.finishTime;
    const stops=[0,5000,10000,15000,Math.max(18500,T-2500),T];
    const mul=Array(stops.length-1).fill(0).map(()=>rnd(0.94,1.06));
    const a=rndi(1,3), b=rndi(2,4);
    mul[a]*=rnd(1.10,1.22); mul[b]*=rnd(1.08,1.18);
    mul[2]*=(0.94+h.stats.stamina*0.12);
    return {stops,mul};
  }
  function seg(stops,t){for(let i=0;i<stops.length-1;i++){if(t>=stops[i]&&t<stops[i+1])return i}return stops.length-2}

  // ----- Countdown then start
  function beginCountdownThenStart(){
    countdownEl.classList.remove('hidden');
    const seq=[3,2,1,0];
    let i=0;
    const tick=()=>{
      countNum.textContent = seq[i]===0 ? 'GO!' : seq[i];
      countNum.className = seq[i]===0 ? 'countGo' : 'countNum';
      if(seq[i]===0){
        setTimeout(()=>{countdownEl.classList.add('hidden'); startRace();},300);
      }else{
        setTimeout(()=>{i++; tick();},1000);
      }
    };
    tick();
  }

  // ----- Animation (leader camera)
  function startRace(){
    gateEl.classList.add('open');
    const TD=state.race.trackDistance, runoff=state.race.runoff;
    state.race.t0=performance.now(); state.race.finished=false; state.race.started=true;
    const vpH=lanesViewport.clientHeight; let last=state.race.t0;
    const maxCam=Math.max(0,state.race.worldHeight-vpH); let camY=0; lanesWorld.style.transform=`translateY(${-camY}px)`;

    function frame(now){
      const dt=(now-last)/1000; last=now; const t=now-state.race.t0;
      let allOff=true;

      // advance horses
      for(const S of state.race.sprites){
        if(S.offtrack) continue;
        const i=seg(S.plan.stops,t);
        let v=S.vBase*S.plan.mul[i];
        v*=1+0.02*Math.sin((t/1000)*(1.2+S.h.stats.burst*1.6));
        S.y += v*dt;

        // tighten finish window
        const lastI=S.plan.stops.length-2;
        if(i===lastI){
          const rt=(S.h.finishTime-t)/1000, rd=TD-S.y;
          if(rt>0){ v=v*0.5 + (rd/rt)*0.5; S.y += v*dt; }
        }

        if(!S.crossed && S.y>=TD){
          S.crossed=true; S.crossTime=t; S.rank=state.race.rankCounter++;
          state.race.results.push({horseId:S.h.id,finishTime:S.crossTime,rank:S.rank});
        }

        if(S.y>=TD+runoff){ S.y=TD+runoff; S.offtrack=true; } else allOff=false;

        S.el.style.transform=`translate(0, ${S.y}px)`;
      }

      // live positions + badges
      const live=[...state.race.sprites].sort((a,b)=>b.y-a.y);
      state.race.sprites.forEach(S=>S.el.classList.remove('top1','top2','top3','leader'));
      live.forEach((S,i)=>{ if(i===0)S.el.classList.add('top1','leader'); else if(i===1)S.el.classList.add('top2'); else if(i===2)S.el.classList.add('top3'); S.posEl.textContent=ordinal(i+1); });

      // camera on the leader (furthest down)
      const leader=live[0];
      const leaderWorldY = state.race.padTop + leader.y;
      // keep leader ~60% down the viewport
      const target = clamp(leaderWorldY - vpH*0.60, 0, maxCam);
      camY += (target - camY) * 0.14;
      // hard bounds to avoid leader popping out
      const leaderScreenY = leaderWorldY - camY;
      if(leaderScreenY < vpH*0.35) camY = clamp(leaderWorldY - vpH*0.35, 0, maxCam);
      if(leaderScreenY > vpH*0.75) camY = clamp(leaderWorldY - vpH*0.75, 0, maxCam);
      lanesWorld.style.transform=`translateY(${-camY}px)`;

      if(allOff || t>=state.race.duration+4000){ endRace(false); return; }
      state.race.raf=requestAnimationFrame(frame);
    }
    state.race.raf=requestAnimationFrame(frame);
  }

  function endRace(skip){
    if(state.race.finished) return;
    state.race.finished=true;
    if(state.race.raf) cancelAnimationFrame(state.race.raf);

    const TD=state.race.trackDistance, runoff=state.race.runoff;

    if(skip){
      const order=[...state.race.sprites].sort((a,b)=>b.y-a.y);
      order.forEach((S,i)=>{
        if(!S.crossed){ S.crossed=true; S.crossTime=20000+i*100; S.rank=state.race.rankCounter++; state.race.results.push({horseId:S.h.id,finishTime:S.crossTime,rank:S.rank}); }
        S.y=TD+runoff; S.offtrack=true; S.el.style.transform=`translate(0, ${S.y}px)`;
      });
      lanesWorld.style.transform=`translateY(${-(state.race.worldHeight - lanesViewport.clientHeight)}px)`;
    }else{
      const remain=state.race.sprites.filter(s=>!s.crossed).sort((a,b)=>b.y-a.y);
      if(remain.length){
        const base=(state.race.results.at(-1)?.finishTime)||20000;
        remain.forEach((S,i)=>{
          S.crossed=true; S.crossTime=base+100+i*50; S.rank=state.race.rankCounter++;
          state.race.results.push({horseId:S.h.id,finishTime:S.crossTime,rank:S.rank});
          S.y=TD+runoff; S.offtrack=true; S.el.style.transform=`translate(0, ${S.y}px)`;
        });
      }
    }

    renderResults(); settle(); show('results');
  }

  // ----- Payouts + results
  function settle(){
    const order=[...state.race.results].sort((a,b)=>a.rank-b.rank).map(r=>r.horseId);
    const first=order[0]; const top3=new Set(order.slice(0,3));
    state.picks.forEach(pk=>{
      const h=state.horses.find(x=>x.id===pk.horseId), p=byId(pk.playerId);
      let win=0;
      if(pk.type==='win' && pk.horseId===first) win=pk.amount*h.odds.win;
      else if(pk.type==='place' && top3.has(pk.horseId)) win=pk.amount*h.odds.place;
      if(win>0) p.balance+=Math.floor(win);
      pk.win=Math.floor(win); pk.result=win>0?'WIN':'LOSE';
    });
  }

  const podium=$('#podium'), orderList=$('#orderList'), playerOutcomes=$('#playerOutcomes');
  $('#nextRound').onclick=()=>{state.round++;startRound();};
  $('#leavePlayers').onclick=()=>{state.players=state.players.filter(p=>p.active&&p.balance>0); if(state.players.length<2){alert('Not enough players.'); fullReset(); return;} state.round++; startRound();};
  $('#fullReset').onclick=fullReset;

  function renderResults(){
    podium.innerHTML='';
    const ord=[...state.race.results].sort((a,b)=>a.rank-b.rank).map(r=>({h:state.horses.find(x=>x.id===r.horseId),t:r.finishTime,rank:r.rank}));
    const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
    ord.slice(0,3).forEach((o,i)=>{
      const d=document.createElement('div'); d.className='kpi';
      d.innerHTML=`<div class="row" style="align-items:center;gap:8px">
        <span style="font-size:1.25rem">${medals[i]}</span>
        <div class="silhouette" style="background:${o.h.color}"></div>
        <strong>${esc(o.h.name)}</strong>
      </div><div class="small">Time: ${(o.t/1000).toFixed(2)}s</div>`;
      podium.appendChild(d);
    });

    orderList.innerHTML='';
    ord.forEach((o)=>{
      const li=document.createElement('li');
      const bettors=state.picks.filter(pk=>pk.horseId===o.h.id).map(pk=>byId(pk.playerId).name);
      li.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="align-items:center;gap:8px">
          <div class="badge">#${o.rank}</div>
          <div class="silhouette" style="background:${o.h.color}"></div>
          <strong>${esc(o.h.name)}</strong>
        </div>
        <div class="small">${bettors.length?("Picked by: "+bettors.map(esc).join(', ')):"No picks"}</div>
      </div>`;
      orderList.appendChild(li);
    });

    playerOutcomes.innerHTML='';
    const by=groupBy(state.picks,'playerId');
    Object.entries(by).forEach(([pid,arr])=>{
      const p=byId(pid), li=document.createElement('li');
      const rows=arr.map(pk=>{
        const h=state.horses.find(x=>x.id===pk.horseId);
        return `<div class="row" style="justify-content:space-between">
          <div>${pk.type.toUpperCase()} â€¢ <span class="pill">${esc(h.name)}</span> â€¢ <span class="small">${fmt(pk.amount)} bet</span></div>
          <div class="${pk.win>0?'money':''}">${pk.result} ${pk.win>0?('+ '+fmt(pk.win)):' '}</div>
        </div>`;
      }).join('');
      li.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <strong>${esc(p.name)}</strong>
        <div>Balance: <span class="money">${fmt(p.balance)}</span></div>
      </div>
      <div class="card" style="margin-top:8px">${rows}</div>`;
      playerOutcomes.appendChild(li);
    });
  }

  function fullReset(){
    state.players=[]; state.round=1; state.order=[]; state.horses=[]; state.picks=[];
    state.race={duration:20000, trackDistance:3200, runoff:100, t0:0, raf:0, finished:false, results:[], sprites:[], worldHeight:0, padTop:24, padBot:24, rankCounter:1, started:false};
    renderPlayers(); show('players');
  }
})();
</script>
</body>
</html>
