<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Photo Finish — Horse Race Multiplayer Betting</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --navy:#0B1F2A; --cream:#FDF5D9; --red:#D43D3D; --ink:#EDE6CB;
    --muted:#C8BEA0; --card:#102636; --track:#0E2230; --lane:#163245;
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:var(--navy);color:var(--ink);font-family:"Space Grotesk",system-ui,Arial,Helvetica,sans-serif}
  h1,h2,h3{margin:0 0 .5rem 0}
  button,input,select{font:inherit}
  .wrap{max-width:940px;margin:0 auto;padding:16px 16px 80px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid #1e3a4a;border-radius:14px;padding:14px}
  .cta{background:var(--red);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700}
  .cta[disabled]{opacity:.5}
  .ghost{background:transparent;border:1px solid var(--muted);color:var(--ink);border-radius:12px;padding:10px 14px}
  .pill{background:#123042;color:var(--ink);border:1px solid #22465b;border-radius:999px;padding:6px 10px;font-size:.9rem}
  .label{font-size:.85rem;color:var(--muted)}
  .input{width:100%;background:#0d2230;color:var(--ink);border:1px solid #254b61;border-radius:10px;padding:10px}
  .kpi{display:flex;align-items:center;justify-content:space-between;background:#0f2636;border:1px solid #22465b;border-radius:12px;padding:10px 12px}
  .badge{padding:4px 8px;border-radius:8px;background:#173448;font-size:.85rem}
  .money{font-weight:700;color:#FFE8A3}
  .small{font-size:.9rem;color:var(--muted)}
  .center{text-align:center}
  .hidden{display:none !important}
  .list{list-style:none;padding:0;margin:0}
  .list li{padding:8px 0;border-bottom:1px solid #183244}
  .list li:last-child{border-bottom:none}

  /* Race */
  .race-shell{position:relative;height:72vh;min-height:460px;border-radius:16px;overflow:hidden;background:linear-gradient(#0B1F2A 0 30%,#0A1D2A 30% 100%);border:1px solid #1f3d50}
  .track{position:absolute;inset:0;display:flex;flex-direction:column;align-items:stretch;justify-content:flex-end;padding:0 8px 64px 8px}
  .lanesViewport{position:relative;margin:0 auto;width:min(720px,100%);height:100%;overflow:hidden}
  .lanesWorld{position:absolute;left:0;right:0;top:0;will-change:transform}
  .lanesBg{position:absolute;inset:0;background:var(--track);border:1px solid #284b5e;border-radius:14px}
  .lane{position:relative;height:60px;border-top:1px dashed #254a5f;background:repeating-linear-gradient(90deg,var(--lane) 0 28px,#133448 28px 56px)}
  .lane:first-child{border-top:none}
  .finishLine{position:absolute;left:8px;right:8px;height:10px;background:repeating-linear-gradient(90deg,#eee 0 18px,#111 18px 36px);border:1px solid #223f51;border-left:none;border-right:none}
  .split{position:absolute;left:8px;right:8px;height:2px;background:#1f3f52;opacity:.5}
  .split label{position:absolute;right:6px;top:-10px;font-size:.75rem;color:#93b7c9}
  .gate{position:absolute;left:8px;right:8px;height:14px;background:repeating-linear-gradient(90deg,#eee 0 18px,#111 18px 36px);border-top:1px solid #223f51;transform-origin:bottom;transform:scaleY(1);transition:transform .45s ease}
  .gate.open{transform:scaleY(0)}
  .horse{position:absolute;left:14px;display:flex;align-items:center;gap:10px}
  .silhouette{width:44px;height:32px;border-radius:6px;box-shadow:0 0 0 2px rgba(0,0,0,.25) inset}
  .horseTag{background:#0f2a3a;border:1px solid #2b4d60;color:var(--ink);padding:6px 8px;border-radius:10px;font-weight:600;white-space:nowrap}
  .leader{filter:drop-shadow(0 0 10px rgba(212,61,61,.6))}
  .top2 .horseTag{border-color:#d0be6b}
  .top1 .horseTag{border-color:#ffd46b}
  .top3 .horseTag{border-color:#9bd4ff}
  .ticker{position:absolute;top:12px;left:12px;right:12px;display:flex;gap:8px;flex-wrap:wrap}
  .ticker .chip{background:#0e2b3f;border:1px solid #2a4c60;border-radius:999px;padding:6px 10px;font-size:.9rem}

  .sticky-footer{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(11,31,42,0),rgba(11,31,42,.95));padding:8px 12px 16px}
  .footer-bar{max-width:940px;margin:0 auto;display:flex;gap:8px}
  .grow{flex:1}
  @media (min-width:720px){
    .wrap{padding:20px 20px 88px}
    .lane{height:66px}
    .silhouette{width:50px;height:36px}
  }

  /* Odds + Stats */
  .odds{display:flex;gap:8px;flex-wrap:wrap}
  .odds .chip{background:#123043;border:1px solid #274c5f;border-radius:999px;padding:6px 10px}
  .statRow{display:flex;gap:8px;align-items:center;margin-top:6px}
  .statLabel{width:64px;font-size:.8rem;color:#c6d4de}
  .bar{flex:1;height:8px;background:#183647;border:1px solid #2a4c60;border-radius:6px;overflow:hidden}
  .bar>span{display:block;height:100%;background:#70d6ff}
  .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:.85rem;color:#a9c0cd}
  .legend .key{display:flex;gap:6px;align-items:center}
  .legend .swatch{width:14px;height:8px;border-radius:3px}
  .lg-speed{background:#70d6ff}
  .lg-stamina{background:#ffd46b}
  .lg-burst{background:#ff9bb5}
</style>
</head>
<body>
<div class="wrap">
  <header class="row" style="align-items:center;justify-content:space-between">
    <h1>Photo Finish</h1>
    <div class="pill">20s race • Local Multiplayer</div>
  </header>

  <!-- Add Players -->
  <section id="screen-players" class="grid">
    <div class="card grid" style="gap:12px">
      <h2>Add Players</h2>
      <div class="row">
        <div class="kpi grow">
          <div>
            <div class="label">Starting Balance</div>
            <div class="money" id="startMoneyShow">1000</div>
          </div>
          <input id="startMoney" class="input" type="number" min="100" step="50" value="1000" style="max-width:160px">
        </div>
      </div>
      <div class="row">
        <input id="playerName" class="input grow" placeholder="Player name">
        <button id="addPlayer" class="cta">Add</button>
      </div>
      <div class="row">
        <button class="ghost quick" data-n="2">Quick add 2</button>
        <button class="ghost quick" data-n="3">3</button>
        <button class="ghost quick" data-n="4">4</button>
        <button class="ghost quick" data-n="5">5</button>
        <button class="ghost quick" data-n="6">6</button>
      </div>
      <ul id="playerList" class="list"></ul>
      <div class="row">
        <button id="startGame" class="cta" disabled>Start Game</button>
        <button id="resetAll" class="ghost">Reset</button>
      </div>
    </div>
  </section>

  <!-- Selection -->
  <section id="screen-select" class="grid hidden">
    <div class="card grid" style="gap:10px" id="roundHeader">
      <h2>Horse Selection</h2>
      <div id="turnBanner" class="kpi">
        <div>
          <div class="label">Now selecting</div>
          <div id="currentPlayerName" style="font-weight:700"></div>
        </div>
        <div class="money">Balance: <span id="currentPlayerBalance">0</span></div>
      </div>
      <div class="legend">
        <div class="key"><span class="swatch lg-speed"></span>Speed: base pace</div>
        <div class="key"><span class="swatch lg-stamina"></span>Stamina: mid-race hold</div>
        <div class="key"><span class="swatch lg-burst"></span>Burst: late kick</div>
      </div>
    </div>

    <div class="card grid" style="gap:10px">
      <h3>Horses</h3>
      <div id="horseGrid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px"></div>
    </div>

    <div class="card grid" style="gap:10px">
      <h3>Bet</h3>
      <div class="row">
        <select id="betType" class="input" style="max-width:180px">
          <option value="win">Win</option>
          <option value="place">Place (Top 3)</option>
        </select>
        <input id="betAmount" class="input" type="number" min="1" step="10" value="50" style="max-width:160px">
        <button id="lockPick" class="cta grow" disabled>Lock Pick</button>
      </div>
      <div id="pickPreview" class="small"></div>
    </div>

    <div class="card">
      <h3>Summary</h3>
      <ul id="pickList" class="list"></ul>
      <div class="row">
        <button id="beginRace" class="cta" disabled>Start Race</button>
        <button id="backToPlayers" class="ghost">Back</button>
      </div>
    </div>
  </section>

  <!-- Race -->
  <section id="screen-race" class="grid hidden">
    <div class="card">
      <h2>Race</h2>
      <div class="small">20 seconds • Vertical track • Clean lead changes</div>
    </div>
    <div class="race-shell">
      <div class="ticker" id="raceTicker"></div>
      <div class="track">
        <div class="lanesViewport" id="lanesViewport">
          <div class="lanesWorld" id="lanesWorld">
            <div class="lanesBg" id="lanesBg"></div>
            <div id="finishLine" class="finishLine"></div>
            <div id="splitMarks"></div>
            <div id="laneContainer"></div>
            <div id="gate" class="gate"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="sticky-footer">
      <div class="footer-bar">
        <button id="skipToResults" class="ghost grow">Skip animation</button>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="screen-results" class="grid hidden">
    <div class="card grid" style="gap:8px">
      <h2>Results</h2>
      <div id="podium" class="row"></div>
    </div>
    <div class="card">
      <h3>Final Order</h3>
      <ul id="orderList" class="list"></ul>
    </div>
    <div class="card">
      <h3>Player Outcomes</h3>
      <ul id="playerOutcomes" class="list"></ul>
    </div>
    <div class="row">
      <button id="nextRound" class="cta">Next Race</button>
      <button id="leavePlayers" class="ghost">Remove Leavers</button>
      <button id="fullReset" class="ghost">Reset Game</button>
    </div>
  </section>
</div>

<script>
(function(){
  // --------- State ---------
  const state = {
    players: [],
    startBalance: 1000,
    round: 1,
    order: [],
    horses: [],
    picks: [],
    race: {
      duration: 20000,
      trackDistance: 3200,   // px from gate (0) to finish
      lanes: [],
      t0: 0,
      raf: 0,
      finished: false,
      results: []
    },
  };

  // --------- Helpers ---------
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const fmt = n=>Number(n).toLocaleString();
  const byId = id=>state.players.find(p=>p.id===id);
  const rnd = (a,b)=>Math.random()*(b-a)+a;
  const rndi = (a,b)=>Math.floor(rnd(a,b+1));
  const clamp = (v,a,b)=>Math.min(b,Math.max(a,v));

  const screens = { players:$('#screen-players'), select:$('#screen-select'), race:$('#screen-race'), results:$('#screen-results') };
  function show(which){ Object.values(screens).forEach(s=>s.classList.add('hidden')); screens[which].classList.remove('hidden'); }

  // --------- Players ---------
  const startMoney=$('#startMoney'), startMoneyShow=$('#startMoneyShow'), playerName=$('#playerName'),
        playerList=$('#playerList'), addPlayerBtn=$('#addPlayer'), startGameBtn=$('#startGame'), resetAllBtn=$('#resetAll');

  $$('.quick').forEach(btn=>btn.addEventListener('click',()=>{
    const n=+btn.dataset.n, base=["Alex","Sam","Casey","Jordan","Taylor","Riley","Jamie","Drew","Quinn","Harper"];
    while(state.players.length<n){
      const name=base[(state.players.length)%base.length]+(state.players.length>base.length-1?(" "+(state.players.length+1)):"");
      addPlayer(name);
    }
    renderPlayers();
  }));
  startMoney.addEventListener('input',()=>{ const v=Math.max(100,+startMoney.value||1000); state.startBalance=v; startMoneyShow.textContent=fmt(v); });
  addPlayerBtn.addEventListener('click',()=>{ const name=playerName.value.trim(); if(!name) return; addPlayer(name); playerName.value=''; renderPlayers(); });
  resetAllBtn.addEventListener('click', fullReset);

  function addPlayer(name){ if(state.players.length>=6) return; const id=crypto.randomUUID(); state.players.push({id,name,balance:state.startBalance,active:true}); }
  function removePlayer(id){ state.players=state.players.filter(p=>p.id!==id); }
  function renderPlayers(){
    playerList.innerHTML='';
    state.players.forEach(p=>{
      const li=document.createElement('li');
      li.innerHTML=`<div class="row" style="align-items:center;justify-content:space-between">
        <div><strong>${escapeHtml(p.name)}</strong> <span class="badge">Balance: <span class="money">${fmt(p.balance)}</span></span></div>
        <div class="row"><button class="ghost" data-id="${p.id}">Remove</button></div>
      </div>`;
      playerList.appendChild(li);
    });
    $$('#playerList button').forEach(b=>b.onclick=()=>{ removePlayer(b.dataset.id); renderPlayers(); });
    startGameBtn.disabled = state.players.length<2;
  }
  startGameBtn.addEventListener('click',()=>{ state.round=1; startRound(); });

  // --------- Selection ---------
  const turnBanner=$('#turnBanner'), currentPlayerName=$('#currentPlayerName'), currentPlayerBalance=$('#currentPlayerBalance'),
        horseGrid=$('#horseGrid'), pickList=$('#pickList'), betType=$('#betType'), betAmount=$('#betAmount'),
        lockPick=$('#lockPick'), beginRace=$('#beginRace'), backToPlayers=$('#backToPlayers'), pickPreview=$('#pickPreview');
  backToPlayers.addEventListener('click',()=>show('players'));

  function startRound(){
    state.picks=[]; state.order=shuffle(state.players.filter(p=>p.active).map(p=>p.id));
    state.horses=genHorses(6);
    state.race.finished=false; state.race.results=[];
    renderSelect(); show('select'); currentTurnIndex=0; prepareNextTurn();
  }

  function renderSelect(){
    horseGrid.innerHTML='';
    state.horses.forEach(h=>{
      const card=document.createElement('div'); card.className='card'; card.style.cursor='pointer'; card.dataset.hid=h.id;
      card.innerHTML=`
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="row" style="align-items:center;gap:10px">
            <div class="silhouette" style="background:${h.color}"></div>
            <div>
              <div style="font-weight:700">${escapeHtml(h.name)}</div>
              <div class="statRow"><div class="statLabel">Speed</div><div class="bar"><span style="width:${pct(h.stats.speed)}%"></span></div></div>
              <div class="statRow"><div class="statLabel">Stamina</div><div class="bar"><span style="width:${pct(h.stats.stamina)}%;background:#ffd46b"></span></div></div>
              <div class="statRow"><div class="statLabel">Burst</div><div class="bar"><span style="width:${pct(h.stats.burst)}%;background:#ff9bb5"></span></div></div>
            </div>
          </div>
          <div class="odds">
            <span class="chip">Win <strong class="hl">${h.odds.win.toFixed(2)}x</strong></span>
            <span class="chip">Place <strong>${h.odds.place.toFixed(2)}x</strong></span>
          </div>
        </div>`;
      card.addEventListener('click',()=>selectHorse(h.id));
      horseGrid.appendChild(card);
    });
    renderPicks();
  }
  const pct = v=>Math.round(clamp(v,0,1)*100);

  let currentTurnIndex=0, selectedHorseId=null;
  function prepareNextTurn(){
    if(currentTurnIndex>=state.order.length){ beginRace.disabled=false; turnBanner.classList.add('hidden'); return; }
    beginRace.disabled=true; turnBanner.classList.remove('hidden'); selectedHorseId=null; lockPick.disabled=true;
    const pid=state.order[currentTurnIndex], p=byId(pid);
    currentPlayerName.textContent=p.name; currentPlayerBalance.textContent=fmt(p.balance);
    betAmount.value=Math.min(100,p.balance); pickPreview.textContent='';
    $$('#horseGrid .card').forEach(c=>c.style.outline='1px solid #1e3a4a');
  }
  function selectHorse(hid){ selectedHorseId=hid; $$('#horseGrid .card').forEach(c=>c.style.outline=c.dataset.hid===hid?'2px solid var(--red)':'1px solid #1e3a4a'); updatePreview(); }
  function updatePreview(){
    const pid=state.order[currentTurnIndex], p=byId(pid), amt=clamp(+betAmount.value||0,1,p.balance); betAmount.value=amt;
    if(!selectedHorseId){ lockPick.disabled=true; pickPreview.textContent=''; return; }
    const h=state.horses.find(x=>x.id===selectedHorseId), t=betType.value, mult=t==='win'?h.odds.win:h.odds.place;
    pickPreview.textContent=`${p.name} → ${h.name} • ${t.toUpperCase()} • ${fmt(amt)} @ ${mult.toFixed(2)}x`;
    lockPick.disabled=false;
  }
  betType.addEventListener('change',updatePreview); betAmount.addEventListener('input',updatePreview);

  lockPick.addEventListener('click',()=>{
    const pid=state.order[currentTurnIndex], p=byId(pid), amt=clamp(+betAmount.value||0,1,p.balance);
    if(!selectedHorseId||amt<1) return;
    state.picks.push({playerId:p.id,horseId:selectedHorseId,type:betType.value,amount:amt});
    p.balance-=amt; currentTurnIndex++; renderPicks(); prepareNextTurn();
  });

  function renderPicks(){
    pickList.innerHTML='';
    state.order.forEach(pid=>{
      const p=byId(pid), pick=state.picks.find(x=>x.playerId===pid), li=document.createElement('li');
      if(pick){ const h=state.horses.find(x=>x.id===pick.horseId);
        li.innerHTML=`<strong>${escapeHtml(p.name)}</strong> → ${h.badge()} • <span class="badge">${pick.type.toUpperCase()}</span> • <span class="money">${fmt(pick.amount)}</span>`;
      } else { li.innerHTML=`<strong>${escapeHtml(p.name)}</strong> is choosing…`; }
      pickList.appendChild(li);
    });
  }

  $('#beginRace').addEventListener('click',()=>{ setupRaceView(); show('race'); startRaceAnimation(); });
  $('#skipToResults').addEventListener('click',()=>{ endRaceAndScore(true); });

  // --------- Horses ---------
  function genHorses(n){
    const colors=distinctColors(n), names=uniqueHorseNames(n);
    return Array.from({length:n}).map((_,i)=>{
      const speed=clamp(randn(0.65,0.15),0.35,1), stamina=clamp(randn(0.65,0.15),0.35,1), burst=clamp(randn(0.65,0.15),0.35,1);
      const quality=speed*0.5+stamina*0.3+burst*0.2;
      const baseTime=rnd(19.2,21.5)-(quality-0.65)*2.0;
      const finishTime=clamp(baseTime,18.8,22.5)*1000;
      const winOdds=clamp(1.6+(1.0-quality)*2.4+rnd(0,0.4),1.4,4.6);
      const placeOdds=clamp(winOdds*rnd(0.5,0.7),1.2,Math.max(1.2,winOdds*0.85));
      const id=crypto.randomUUID();
      return { id, name:names[i], color:colors[i], stats:{speed,stamina,burst,quality}, finishTime,
        odds:{win:winOdds, place:placeOdds},
        badge(){return `<span class="pill"><span class="silhouette" style="display:inline-block;vertical-align:middle;margin-right:6px;background:${this.color};width:14px;height:10px;border-radius:3px"></span>${escapeHtml(this.name)}</span>`;}
      };
    });
  }
  function uniqueHorseNames(n){
    const A=["Crimson","Silent","Lucky","Misty","Rapid","Royal","Golden","Shadow","Copper","Icy","Celestial","Wild","Noble","Brave","Silver","Velvet","Savvy","Stout","Amber","Indigo"];
    const B=["Blaze","Echo","Stride","Comet","Whisper","Dash","Thorn","Venture","Charm","Orbit","Surge","Monarch","Spirit","Horizon","Anthem","Rally","Signal","Voyage","Badge","Tango"];
    const used=new Set(), list=[]; while(list.length<n){ const w1=A[rndi(0,A.length-1)], w2=B[rndi(0,B.length-1)]; if(used.has(w1)||used.has(w2)) continue; used.add(w1); used.add(w2); list.push(`${w1} ${w2}`); } return list;
  }
  function distinctColors(n){ return Array.from({length:n}).map((_,i)=>`hsl(${Math.round(i*360/n)} 70% 55%)`); }

  // --------- Race view (camera-fixed lanes) ---------
  const lanesViewport=$('#lanesViewport'), lanesWorld=$('#lanesWorld'), lanesBg=$('#lanesBg'),
        laneContainer=$('#laneContainer'), raceTicker=$('#raceTicker'),
        splitMarks=$('#splitMarks'), gateEl=$('#gate'), finishEl=$('#finishLine');

  function setupRaceView(){
    laneContainer.innerHTML=''; raceTicker.innerHTML=''; splitMarks.innerHTML=''; gateEl.classList.remove('open');
    const TD=state.race.trackDistance, laneH=64, paddingTop=24, paddingBottom=24;

    // Set world height: lanes area + padding
    const worldH = TD + paddingTop + paddingBottom;
    lanesWorld.style.height = worldH+'px';
    lanesBg.style.height = worldH+'px';

    // Finish and gate positions
    finishEl.style.top = (paddingTop)+'px';
    gateEl.style.bottom = (paddingBottom)+'px';

    // Splits at 25/50/75% from gate upward
    [0.25,0.5,0.75].forEach(f=>{
      const y = paddingTop + (TD - TD*f);
      const s = document.createElement('div'); s.className='split'; s.style.top = y+'px';
      const lab=document.createElement('label'); lab.textContent = Math.round(f*100)+'%'; s.appendChild(lab);
      splitMarks.appendChild(s);
    });

    // Build lanes and horses
    state.race.lanes = state.horses.map((h,idx)=>{
      const lane=document.createElement('div'); lane.className='lane'; lane.style.height=laneH+'px';
      const horse=document.createElement('div'); horse.className='horse'; horse.dataset.hid=h.id;
      horse.style.bottom = (paddingBottom)+'px'; // start at gate
      horse.style.top = 'auto'; // ensure bottom positioning
      horse.style.left = '14px';

      // vertical offset per lane
      lane.style.position='relative';
      lane.style.transform=`translateY(${paddingTop + (TD - 0)}px)`; // lanes stacked under world; horses move via bottom

      const body=document.createElement('div'); body.className='silhouette'; body.style.background=h.color;
      const tag=document.createElement('div'); tag.className='horseTag'; tag.innerHTML=`${escapeHtml(h.name)} <span class="small">(${h.odds.win.toFixed(2)}x / ${h.odds.place.toFixed(2)}x)</span>`;
      horse.append(body,tag); lane.appendChild(horse); laneContainer.appendChild(lane);

      return { h, el:horse, laneEl:lane, y:0, vBase: TD/(h.finishTime/1000), segments: makeSegments(h), finished:false, finishTime:null, paddingBottom };
    });

    // Align lanes block inside world
    laneContainer.style.position='absolute';
    laneContainer.style.left='0'; laneContainer.style.right='0';
    laneContainer.style.bottom = paddingBottom+'px'; // base
    laneContainer.style.transform = `translateY(0)`; // horses move; lanes stay

    // Ticker chips
    state.horses.forEach(h=>{
      const chip=document.createElement('div'); chip.className='chip';
      chip.innerHTML=`${h.badge()} • Win <strong>${h.odds.win.toFixed(2)}x</strong> • Place <strong>${h.odds.place.toFixed(2)}x</strong>`;
      raceTicker.appendChild(chip);
    });
  }

  // Pace plan
  function makeSegments(h){
    const T=h.finishTime;
    const stops=[0,5000,10000,15000,Math.max(18500,T-2500),T];
    const base=Array(stops.length-1).fill(0).map(()=>rnd(0.94,1.06));
    const a=rndi(1,3), b=rndi(2,4); base[a]*=rnd(1.10,1.22); base[b]*=rnd(1.08,1.18);
    base[2]*=(0.94+h.stats.stamina*0.12);
    return {stops, mul:base};
  }
  function currentSegment(stops,t){ for(let i=0;i<stops.length-1;i++){ if(t>=stops[i]&&t<stops[i+1]) return i; } return stops.length-2; }

  // --------- Animation (absolute bottom + single camera) ---------
  function startRaceAnimation(){
    setTimeout(()=>gateEl.classList.add('open'), 400);
    state.race.t0=performance.now(); state.race.finished=false;
    const viewportH = lanesViewport.clientHeight;
    let last=state.race.t0;

    function frame(now){
      const dt=(now-last)/1000; last=now; const tRace=now-state.race.t0;
      const TD=state.race.trackDistance; let allFinished=true;

      for(const L of state.race.lanes){
        if(L.finished) continue;
        const seg=currentSegment(L.segments.stops,tRace);
        let v=L.vBase*L.segments.mul[seg];
        v*=1+0.02*Math.sin((tRace/1000)*(1.2+L.h.stats.burst*1.6));
        L.y += v*dt;
        // solve end
        const idxLast=L.segments.stops.length-2;
        if(seg===idxLast){
          const remainT=(L.h.finishTime - tRace)/1000, remainD=TD - L.y;
          if(remainT>0){ const needV=remainD/remainT; v=v*0.5+needV*0.5; L.y += v*dt; }
        }
        if(L.y>=TD){ L.y=TD; L.finished=true; L.finishTime=Math.max(tRace,0); state.race.results.push({horseId:L.h.id, finishTime:L.finishTime}); }
        else allFinished=false;

        // move horse: bottom from gate (paddingBottom) + progress
        L.el.style.bottom = (L.paddingBottom + L.y) + 'px';
      }

      // Camera follows leader; world moves up
      const maxY=Math.max(...state.race.lanes.map(L=>L.y));
      const worldTop = Math.max(0, Math.min(maxY - viewportH*0.6, TD - viewportH + 40));
      lanesWorld.style.transform = `translateY(${-worldTop}px)`;

      // Live top-3
      const live=[...state.race.lanes].sort((a,b)=>b.y-a.y);
      live.forEach((L,i)=>{ L.el.classList.remove('top1','top2','top3','leader'); if(i===0) L.el.classList.add('top1','leader'); if(i===1) L.el.classList.add('top2'); if(i===2) L.el.classList.add('top3'); });

      if(allFinished || tRace>=state.race.duration+3000){ endRaceAndScore(false); return; }
      state.race.raf=requestAnimationFrame(frame);
    }
    state.race.raf=requestAnimationFrame(frame);
  }

  function endRaceAndScore(skip){
    if(state.race.finished) return; state.race.finished=true; if(state.race.raf) cancelAnimationFrame(state.race.raf);
    if(skip){
      const viewportH = lanesViewport.clientHeight, TD=state.race.trackDistance;
      const ordered=[...state.race.lanes].sort((a,b)=>b.y-a.y);
      const baseT=20000;
      ordered.forEach((L,i)=>{ L.finishTime=baseT+i*120+rnd(0,60); L.y=TD; L.el.style.bottom=(L.paddingBottom+L.y)+'px'; });
      state.race.results=ordered.map(L=>({horseId:L.h.id, finishTime:L.finishTime}));
      lanesWorld.style.transform = `translateY(${-(TD - viewportH + 40)}px)`;
    }else{
      if(state.race.results.length!==state.horses.length){
        const remain=state.horses.filter(h=>!state.race.results.find(r=>r.horseId===h.id));
        const base=Math.max(...state.race.results.map(r=>r.finishTime)); remain.forEach((h,i)=>state.race.results.push({horseId:h.id,finishTime:base+100+i*50}));
      }
    }
    state.race.results.sort((a,b)=>a.finishTime-b.finishTime);
    payout(); renderResults(); show('results');
  }

  // --------- Payouts ---------
  function payout(){
    const order=state.race.results.map(r=>r.horseId), first=order[0], top3=new Set(order.slice(0,3));
    state.picks.forEach(pk=>{
      const h=state.horses.find(x=>x.id===pk.horseId), player=byId(pk.playerId);
      let win=0; if(pk.type==='win'&&pk.horseId===first){ win=pk.amount*h.odds.win; }
      else if(pk.type==='place'&&top3.has(pk.horseId)){ win=pk.amount*h.odds.place; }
      if(win>0) player.balance+=Math.floor(win);
      pk.win=Math.floor(win); pk.result=win>0?'WIN':'LOSE';
    });
  }

  // --------- Results ---------
  const podium=$('#podium'), orderList=$('#orderList'), playerOutcomes=$('#playerOutcomes');
  $('#nextRound').addEventListener('click',()=>{ state.round++; startRound(); });
  $('#leavePlayers').addEventListener('click',()=>{
    state.players=state.players.filter(p=>p.active&&p.balance>0);
    if(state.players.length<2){ alert('Not enough players to continue. Start a new game.'); fullReset(); return; }
    state.round++; startRound();
  });
  $('#fullReset').addEventListener('click', fullReset);

  function renderResults(){
    podium.innerHTML='';
    const order=state.race.results.map(r=>({h:state.horses.find(x=>x.id===r.horseId), t:r.finishTime}));
    const medals=['🥇','🥈','🥉'];
    order.slice(0,3).forEach((o,i)=>{
      const d=document.createElement('div'); d.className='kpi';
      d.innerHTML=`<div class="row" style="align-items:center;gap:8px">
        <span style="font-size:1.25rem">${medals[i]}</span>
        <div class="silhouette" style="background:${o.h.color}"></div>
        <strong>${escapeHtml(o.h.name)}</strong>
      </div><div class="small">Time: ${(o.t/1000).toFixed(2)}s</div>`;
      podium.appendChild(d);
    });

    orderList.innerHTML='';
    order.forEach((o,idx)=>{
      const li=document.createElement('li'); const bettors=state.picks.filter(pk=>pk.horseId===o.h.id).map(pk=>byId(pk.playerId).name);
      li.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="align-items:center;gap:8px">
          <div class="badge">#${idx+1}</div>
          <div class="silhouette" style="background:${o.h.color}"></div>
          <strong>${escapeHtml(o.h.name)}</strong>
        </div>
        <div class="small">${bettors.length?("Picked by: "+bettors.map(escapeHtml).join(', ')):"No picks"}</div>
      </div>`;
      orderList.appendChild(li);
    });

    playerOutcomes.innerHTML='';
    const byPlayer=groupBy(state.picks,'playerId');
    Object.entries(byPlayer).forEach(([pid,arr])=>{
      const p=byId(pid), li=document.createElement('li');
      const rows=arr.map(pk=>{
        const h=state.horses.find(x=>x.id===pk.horseId);
        return `<div class="row" style="justify-content:space-between">
          <div>${pk.type.toUpperCase()} • ${h.badge()} • <span class="small">${fmt(pk.amount)} bet</span></div>
          <div class="${pk.win>0?'money':''}">${pk.result} ${pk.win>0?('+ '+fmt(pk.win)):' '}</div>
        </div>`;
      }).join('');
      li.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <strong>${escapeHtml(p.name)}</strong>
        <div>Balance: <span class="money">${fmt(p.balance)}</span></div>
      </div><div class="card" style="margin-top:8px">${rows}</div>`;
      playerOutcomes.appendChild(li);
    });
  }

  // --------- Utils ---------
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=rndi(0,i); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function groupBy(arr,key){ return arr.reduce((m,o)=>((m[o[key]]??=[]).push(o),m),{}); }
  function randn(mu=0,sigma=1){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); return mu+z*sigma; }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
  function fullReset(){
    state.players=[]; state.round=1; state.order=[]; state.horses=[]; state.picks=[];
    state.race={duration:20000, trackDistance:3200, lanes:[], t0:0, raf:0, finished:false, results:[]};
    currentTurnIndex=0; selectedHorseId=null; renderPlayers(); show('players');
  }

  // Init
  renderPlayers();
})();
</script>
</body>
</html>
