<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Photo Finish — Horse Race Multiplayer Betting</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --navy:#003049; --cream:#FDF0D5; --red:#C1121F; --charcoal:#4A4A4A; --burgundy:#780000; --slate:#6D8196; --white:#FFFFFF; --sky:#669BBC;
    --ink:var(--cream);
    --bg:var(--navy);
    --card:#03273c;
    --track:#052334;
    --accent:var(--red);
    --lane1:#FF9999; --lane2:#99CCFF; --lane3:#99FF99; --lane4:#FFCC99; --lane5:#CCCCFF; --lane6:#FFFF99;
    --horse-w:44px; --horse-h:36px; --label-gap:6px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family:"Space Grotesk",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); overflow-x:hidden }
  h1,h2,h3{margin:0 0 .5rem}
  .title{ font-family:"Libre Baskerville", serif; text-align:center; font-size:clamp(32px,4.2vw,56px); letter-spacing:.5px; }
  .raceTitle{ font-family:"Libre Baskerville", serif; text-align:center; font-size:clamp(28px,3.8vw,48px); margin-bottom:4px; }
  .raceMeta,.raceMeta2{ text-align:center; color:#c6d7e2; font-size:.95rem; }
  .wrap{max-width:1000px;margin:0 auto;padding:14px 14px 90px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
  .cta{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .cta[disabled]{opacity:.5;cursor:not-allowed}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,.18);color:#d3e1ea;border-radius:12px;padding:10px 14px;cursor:pointer}
  .pill{background:#123042;color:var(--ink);border:1px solid #22465b;border-radius:999px;padding:6px 10px;font-size:.9rem}
  .label{font-size:.85rem;color:#b6c6d2}
  .input{width:100%;background:#0d2230;color:var(--ink);border:1px solid #254b61;border-radius:10px;padding:10px}
  .kpi{display:flex;align-items:center;justify-content:space-between;background:#0f2636;border:1px solid #22465b;border-radius:12px;padding:10px 12px}
  .badge{padding:4px 8px;border-radius:8px;background:#173448;font-size:.85rem}
  .money{font-weight:700;color:#FFE8A3}
  .small{font-size:.9rem;color:#97adbb}
  .hidden{display:none!important}
  .list{list-style:none;margin:0;padding:0}
  .list li{padding:8px 0;border-bottom:1px solid #183244}
  .list li:last-child{border-bottom:none}

  .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .hdr .spacer{width:40px;height:1px}
  #muteBtn{min-width:84px}

  .statRow{display:flex;gap:8px;align-items:center;margin-top:6px}
  .statBall{width:18px;height:18px;border-radius:50%;display:inline-block}
  .s-speed{background:#70d6ff}.s-stam{background:#ffd46b}.s-burst{background:#ff9bb5}
  .statName{width:80px;font-size:.85rem;color:#b6c6d2;opacity:.95}
  .meter{flex:1;height:8px;background:#173649;border-radius:6px;border:1px solid #274c5f;overflow:hidden}
  .meter>span{display:block;height:100%;background:#70d6ff}.meter.stam>span{background:#ffd46b}.meter.burst>span{background:#ff9bb5}
  .odds{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .odds .chip{background:#123043;border:1px solid #274c5f;border-radius:999px;padding:6px 10px}

  .radios{display:flex;gap:10px;align-items:center}
  .radio-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #274c5f;border-radius:999px;cursor:pointer;background:#123043}
  .radio-pill input{accent-color:var(--accent);}
  .betBtns{display:flex;gap:8px;flex-wrap:wrap}
  .betShow{min-width:72px;text-align:center}

  .race-shell{position:relative;height:74vh;min-height:520px;border-radius:16px;overflow:hidden;background:#0A1D2A;border:1px solid #1f3d50}
  .trackWrap{position:absolute;inset:0;display:flex;flex-direction:column}
  .viewport{position:relative;flex:1;overflow:hidden}
  .world{position:absolute;left:0;right:0;top:0;will-change:transform}
  .bg{position:absolute;left:12px;right:12px;top:0;bottom:0;border:1px solid #274a5e;border-radius:12px;background:var(--track)}
  .laneGuides{position:absolute;left:12px;right:12px;top:0;bottom:0;pointer-events:none}
  .laneGuides .laneLine{position:absolute;top:0;bottom:0;width:2px;background:#2a4c60;opacity:.55}
  .splits{position:absolute;left:12px;right:12px;top:0;pointer-events:none}
  .split{position:absolute;left:0;right:0;height:2px;background:#214559;opacity:.5}
  .split label{position:absolute;right:6px;top:-10px;font-size:.75rem;color:#93b7c9}
  .finishLine{position:absolute;left:12px;right:12px;height:10px;background:repeating-linear-gradient(90deg,#eee 0 18px,#111 18px 36px);border:1px solid #223f51;border-left:none;border-right:none}
  .gate{position:absolute;left:12px;right:12px;height:14px;background:repeating-linear-gradient(90deg,#eee 0 18px,#111 18px 36px);border-bottom:1px solid #223f51;transform-origin:top;transform:scaleY(1);transition:transform .35s ease}
  .gate.open{transform:scaleY(0)}
  .horse{position:absolute;display:flex;align-items:center;gap:var(--label-gap);transform:translate(0,0)}
  .icon{width:var(--horse-w);height:var(--horse-h);border-radius:6px;box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;animation:gallop .3s ease-in-out infinite alternate;position:relative}
  @keyframes gallop{from{transform:translateY(0)}to{transform:translateY(-3px)}}

  .pins{position:absolute;left:1px;right:1px;bottom:1px;display:flex;gap:2px;justify-content:center;flex-wrap:wrap;pointer-events:none}
  .picon{width:16px;height:16px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:.6rem;color:#0e1b23;font-weight:900;border:1px solid rgba(0,0,0,.35)}

  .tag{ background:#0f2a3a;border:1px solid #2b4d60;color:var(--ink); padding:4px 7px;border-radius:10px;font-weight:600;white-space:nowrap;display:flex;align-items:center;gap:6px; max-width:240px;overflow:hidden;font-size:.9rem; }
  .pos{min-width:30px;text-align:center;border-radius:8px;background:#173448;border:1px solid #31576a;padding:2px 5px;font-weight:800}
  .hName{display:inline-block;overflow:hidden}
  .hName .hInner{display:inline-block;white-space:nowrap;will-change:transform}
  .hName.scroll .hInner{animation:nameScroll var(--dur,8s) linear infinite alternate}
  @keyframes nameScroll{from{transform:translateX(0)}to{transform:translateX(calc(-1 * var(--scrollX,0px)))}}

  .leaderGlow{filter:drop-shadow(0 0 10px rgba(255,215,0,.75))}
  .top1 .icon{box-shadow:0 0 0 2px #FFD700 inset, 0 0 14px rgba(255,215,0,.7)}
  .top1 .tag{border-color:#FFD700}
  .top2 .icon{box-shadow:0 0 0 2px #C0D6E4 inset, 0 0 10px rgba(192,214,228,.55)}
  .top2 .tag{border-color:#C0D6E4}
  .top3 .icon{box-shadow:0 0 0 2px #7C5A2B inset, 0 0 6px rgba(124,90,43,.45)}
  .top3 .tag{border-color:#7C5A2B}

  .countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:5;pointer-events:none;background:radial-gradient(circle at 50% 45%, rgba(10,25,35,.45), rgba(10,25,35,.8) 60%, rgba(10,25,35,.95))}
  .countText{font-size:12vmin;font-weight:800;color:#fff;text-shadow:0 2px 0 rgba(0,0,0,.35)}
  .countGo{font-size:9vmin;color:#FFE8A3}
  .toast{position:absolute;left:50%;top:14%;transform:translateX(-50%);background:#123a2a;border:1px solid #1e5a44;color:#dbffe9;padding:12px 16px;border-radius:12px;z-index:6;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .toast.hidden{display:none}
  .winBanner{background:#0f2a3a;border:1px solid #2d556a;border-radius:14px;padding:12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .winBadge{background:#1c7c4a;border:1px solid #2bb36d;color:#eafff4;border-radius:999px;padding:6px 10px;font-weight:800}
  .lossBadge{background:#5b1b1b;border:1px solid #a33131;color:#ffe4e4;border-radius:999px;padding:6px 10px;font-weight:800}
  .fadeTrack .laneGuides,.fadeTrack .splits{opacity:0;transition:opacity .6s ease}
  .raceFooter{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(11,31,42,0),rgba(11,31,42,.96));padding:10px 14px 16px}
  .raceFooter .inner{max-width:1000px;margin:0 auto;display:flex;gap:8px}
  #confetti{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .5s ease}
  #confetti.show{opacity:1}

  #currentPlayerName{font-size:1.35rem;font-weight:800;letter-spacing:.2px}

  /* Eliminated visual */
  .eliminated{opacity:.65;filter:grayscale(1);position:relative}
  .eliminated::after{
    content:"ELIMINATED";
    position:absolute; right:12px; top:-8px;
    background:#5b1b1b; border:1px solid #a33131; color:#ffe4e4;
    padding:4px 8px; border-radius:10px; font-weight:800; font-size:.8rem;
    animation:popIn .35s ease;
  }
  @keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}

  /* Modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal.hidden{display:none}
  .panel{background:#0f2a3a;border:1px solid #2d556a;border-radius:16px;padding:18px;max-width:620px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .panel h2{font-family:"Libre Baskerville",serif;margin-bottom:8px}
  .center{text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header class="hdr">
    <div class="spacer"></div>
    <h1 class="title" style="flex:1">Photo Finish</h1>
    <button id="muteBtn" class="ghost" aria-pressed="false" title="Toggle sound" type="button">🔊 Sound</button>
  </header>

  <!-- Add Players -->
  <section id="screen-players" class="grid">
    <div class="card grid">
      <h2 style="font-family:'Libre Baskerville',serif;font-size:1.6rem">Add Players</h2>
      <div class="row" style="align-items:center">
        <div class="kpi" style="flex:1">
          <div><div class="label">Starting balance</div><div class="money" id="startBalanceShow">1000</div></div>
          <input id="startBalance" class="input" type="number" min="100" step="50" value="1000" style="max-width:160px" />
        </div>
      </div>
      <div class="row">
        <input id="playerName" class="input" placeholder="Player name" style="flex:1" />
        <button id="addPlayer" class="cta" type="button">Add</button>
      </div>
      <div class="row">
        <button class="ghost quick" data-n="2" type="button">Quick add 2</button>
        <button class="ghost quick" data-n="3" type="button">3</button>
        <button class="ghost quick" data-n="4" type="button">4</button>
        <button class="ghost quick" data-n="5" type="button">5</button>
        <button class="ghost quick" data-n="6" type="button">6</button>
      </div>
      <ul id="playerList" class="list"></ul>
      <div class="row">
        <button id="startGame" class="cta" type="button" disabled>Start Game</button>
        <button id="resetAll" class="ghost" type="button">Reset</button>
      </div>
    </div>
  </section>

  <!-- Selection -->
  <section id="screen-select" class="grid hidden">
    <div class="card grid">
      <h2 style="font-family:'Libre Baskerville',serif;font-size:1.6rem">Horse Selection</h2>
      <div id="selectMeta" class="raceMeta">—</div>
      <div id="turnBanner" class="kpi">
        <div><div class="label">Now selecting</div><div id="currentPlayerName" style="font-weight:800"></div></div>
        <div class="money">Balance: <span id="currentPlayerBalance">0</span></div>
      </div>
    </div>

    <div class="card grid">
      <h3 style="font-family:'Libre Baskerville',serif">Horses</h3>
      <div id="horseGrid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:10px"></div>
    </div>

    <div class="card grid">
      <h3 style="font-family:'Libre Baskerville',serif">Bet</h3>
      <div class="row" style="width:100%;align-items:center">
        <div class="radios" role="radiogroup" aria-label="Bet Type">
          <label class="radio-pill"><input type="radio" name="betType" value="win" checked> Win</label>
          <label class="radio-pill"><input type="radio" name="betType" value="place"> Place (Top 3)</label>
        </div>
        <div style="margin-left:auto" class="row">
          <span class="pill betShow money" id="betAmountShow">0</span>
        </div>
      </div>
      <div class="betBtns">
        <button class="ghost" id="betPlus50" type="button">+50</button>
        <button class="ghost" id="betPlus100" type="button">+100</button>
        <button class="ghost" id="betAllIn" type="button">All-in</button>
        <button class="ghost" id="betReset" type="button">Reset</button>
        <button id="lockPick" class="cta" style="margin-left:auto" type="button" disabled>Lock Pick</button>
      </div>
      <div id="pickPreview" class="small"></div>
    </div>

    <div class="card">
      <h3 style="font-family:'Libre Baskerville',serif">Summary</h3>
      <ul id="pickList" class="list"></ul>
      <div class="row">
        <button id="beginRace" class="cta" type="button" disabled>Start Race</button>
        <button id="backToPlayers" class="ghost" type="button">Back</button>
      </div>
    </div>
  </section>

  <!-- Race -->
  <section id="screen-race" class="grid hidden">
    <div class="card">
      <div class="raceTitle">Race</div>
      <div id="raceMeta" class="raceMeta2">—</div>
    </div>
    <div id="raceShell" class="race-shell">
      <div id="toast" class="toast hidden">We have a winner!</div>
      <div class="trackWrap">
        <div class="viewport" id="viewport">
          <div class="world" id="world">
            <div class="bg" id="bg"></div>
            <div class="laneGuides" id="laneGuides"></div>
            <div class="splits" id="splits"></div>
            <div id="finishLine" class="finishLine"></div>
            <div id="gate" class="gate"></div>
          </div>
          <div class="countdown hidden" id="countdown"><div id="countNum" class="countText">3</div></div>
        </div>
      </div>
    </div>
    <div class="raceFooter">
      <div class="inner">
        <button id="skipToResults" class="ghost" style="flex:1" type="button">Skip animation</button>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="screen-results" class="grid hidden">
    <div id="roundBanner" class="winBanner hidden"></div>
    <div class="card grid"><h2 style="font-family:'Libre Baskerville',serif">Results</h2><div id="podium" class="row"></div></div>
    <div class="card"><h3 style="font-family:'Libre Baskerville',serif">Final Order</h3><ul id="orderList" class="list"></ul></div>
    <div class="card"><h3 style="font-family:'Libre Baskerville',serif">Player Outcomes</h3><ul id="playerOutcomes" class="list"></ul></div>
    <div class="row">
      <button id="nextRound" class="cta" type="button">Next Race</button>
      <button id="leavePlayers" class="ghost" type="button">Remove Leavers</button>
      <button id="fullReset" class="ghost" type="button">Reset Game</button>
    </div>
  </section>
</div>

<!-- Confetti + toasts -->
<canvas id="confetti"></canvas>
<div id="sysToast" class="toast hidden" style="position:fixed;top:12%;left:50%;transform:translateX(-50%);z-index:60"></div>

<!-- Game Over (elimination) modal -->
<div id="koModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="koTitle">
  <div class="panel center">
    <h2 id="koTitle">❌ Game Over</h2>
    <div id="koBody" class="small" style="margin-bottom:10px">—</div>
    <div class="row" style="justify-content:center;gap:10px;margin-top:8px">
      <button id="koNext" class="cta" type="button">Continue</button>
    </div>
  </div>
</div>

<!-- Last Player Standing modal -->
<div id="champModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="champTitle">
  <div class="panel center">
    <h2 id="champTitle">🏆 Last Player Standing</h2>
    <div id="champBody" class="small" style="margin-bottom:10px">—</div>
    <div class="row" style="justify-content:center;gap:10px;margin-top:8px">
      <button id="btnPlayAgain" class="cta" type="button">Play Again</button>
      <button id="btnBackStart" class="ghost" type="button">Back to Start</button>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
function uid(){
  try{ if (window.crypto && typeof window.crypto.randomUUID==='function') return window.crypto.randomUUID(); }catch(e){}
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});
}
var $=s=>document.querySelector(s), $$=s=>Array.prototype.slice.call(document.querySelectorAll(s));
var clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
var rnd=(a,b)=>Math.random()*(b-a)+a, rndi=(a,b)=>Math.floor(rnd(a,b+1));
var fmt=n=>Number(n).toLocaleString();
var esc=s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
var ordinal=n=>n===1?'1st':n===2?'2nd':n===3?'3rd':(n+'th');
function shuffle(a){for(let i=a.length-1;i>0;i--){let j=rndi(0,i),t=a[i];a[i]=a[j];a[j]=t;}return a;}
function groupBy(arr,key){let out={}; for(let o of arr){let k=o[key]; (out[k]||(out[k]=[])).push(o);} return out;}
function randn(mu,s){let u=0,v=0;while(u===0)u=Math.random();while(v===0)v=Math.random();let z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);return mu+z*s;}
var initials=n=>n.split(/\s+/).map(w=>w[0]||'').join('').slice(0,2).toUpperCase();
var lerp=(a,b,t)=>a+(b-a)*t;

/* ===== Data ===== */
var PLAYER_COLORS=["#E879F9","#60A5FA","#34D399","#FBBF24","#F87171","#A78BFA"];
var DEFAULT_NAMES=["James","Mike","Lex","Gord","Colin","Julien"];
var REAL_NAMES=[ "Secretariat","Man o’ War","Seabiscuit","Citation","War Admiral","Affirmed","Alydar","Spectacular Bid","Sunday Silence","Easy Goer","Northern Dancer","Ruffian","Zenyatta","Black Caviar","Frankel","American Pharoah","Justify","Flightline","Arrogate","Curlin","Ghostzapper","Gun Runner","California Chrome","Winx","Phar Lap","Omaha","Whirlaway","Count Fleet","Gallant Fox","Native Dancer","Bold Ruler","Nashua","Kelso","Buckpasser","Forego","John Henry","Damascus","Dr. Fager","Alysheba","Cigar","Invasor","Peintre Celebre","Dancing Brave","Dubai Millennium","Sea The Stars","Galileo","Montjeu","Deep Impact","Harbinger","Enable","Tiger Roll","Red Rum","Desert Orchid","Kauto Star","Sprinter Sacre","Denman","Big Brown","Smarty Jones","Funny Cide","Barbaro","Rags to Riches","Lady’s Secret","Winning Colors","Genuine Risk","Serena’s Song","Personal Ensign","Beholder","Monomoy Girl","Rachel Alexandra","Havre de Grace","Blind Luck","Songbird","Tepin","Goldikova","Treve","Miesque","Dahlia","Ouija Board","Fantastic Light","Highland Reel","Crystal Ocean","Poet’s Word","Desert Crown","Hurricane Run","Almanzor","Sottsass","Vadeni","Paddington","Ace Impact","City of Troy","Auguste Rodin","Baaeed","Palace Pier","Pinatubo","Too Darn Hot","Blue Point","Lord Kanaloa","Lys Gracieux","Chrono Genesis","Almond Eye","Drefong","Nature Strip","Anamoe","Giga Kick","I Wish I Win","Verry Elleegant","Incentivise","Romantic Warrior","Golden Sixty","Beauty Generation","Able Friend","Silent Witness","Sacred Kingdom","Fairy King Prawn","Lucky Sweynesse","Wellington","Lucky Nine","Pakistan Star","Aerovelocity","Danon Smash","Satono Crown","Kizuna","Real Steel","Victoire Pisa","Just A Way","Orfevre","Buena Vista","Vodka","Daiwa Scarlet","Admire Moon","Heart’s Cry","King Kamehameha","El Condor Pasa","Agnes World","Agnes Digital","Eishin Preston","Stay Gold","Duramente","Contrail","Daring Tact","Loves Only You","Titleholder","Equinox","Liberty Island","Do Deuce","Stars on Earth","Songline","Schnell Meister","Gran Alegria","Indy Champ","Maurice","Harp Star","Gentildonna","Gold Ship","Epiphaneia","Le Vent Se Leve","Chuwa Wizard","T O Keynes","Ushba Tesoro","Panthalassa","Cafe Pharoah","Yoshida","Mind Your Biscuits","Lava Man","Game On Dude","Mucho Macho Man","Paynter","Bayern","Frosted","Honor Code","Tonalist","Palace Malice","Will Take Charge","Shackleford","Dullahan","Hansen","Union Rags","Orb","Palace Episode","Street Sense","Hard Spun","Any Given Saturday","Lawyer Ron","Quality Road","Animal Kingdom","Gio Ponti","Big Drama","Blame","Summer Bird","Mine That Bird","Da’ Tara","Proud Spell","Eight Belles","Dialed In","Always Dreaming","Tapwrit","Essential Quality","Epicenter","Forte","Goldikova II" ];

var VENUE_DATA=[
  {name:"Churchill Downs", dist:2800},{name:"Ascot", dist:3600},{name:"Epsom Downs", dist:3000},{name:"Flemington", dist:3200},
  {name:"Santa Anita Park", dist:2600},{name:"Belmont Park", dist:3000},{name:"Longchamp", dist:2400},{name:"Meydan", dist:2800},
  {name:"Tokyo Racecourse", dist:3400},{name:"Sha Tin", dist:2600},{name:"Happy Valley", dist:2400},{name:"Randwick", dist:3200},
  {name:"Saratoga", dist:2800},{name:"Keeneland", dist:3000},{name:"Del Mar", dist:2600},{name:"York Racecourse", dist:3400},
  {name:"Goodwood", dist:2800},{name:"Aintree", dist:4200},{name:"Cheltenham", dist:3800},{name:"Rosehill Gardens", dist:3000}
];
var CONDITIONS=["Fast","Firm","Good","Good to Soft","Soft","Heavy","Yielding","Standard","Muddy","Sloppy","Good (3)","Soft (6)"];

/* ===== Effects of venue & condition ===== */
function conditionVariance(cond){
  switch(cond){
    case "Fast": case "Firm": return 0.75;
    case "Good": case "Good (3)": case "Standard": return 0.9;
    case "Good to Soft": case "Yielding": return 1.1;
    case "Soft": case "Soft (6)": return 1.2;
    case "Muddy": case "Sloppy": return 1.3;
    case "Heavy": return 1.45;
    default: return 1.0;
  }
}
function distanceWeights(TD){
  var t = clamp((TD - 2700) / (3600 - 2700), 0, 1);
  var shortW = {speed:0.62, stamina:0.13, burst:0.25};
  var longW  = {speed:0.35, stamina:0.50, burst:0.15};
  return { speed:lerp(shortW.speed,longW.speed,t), stamina:lerp(shortW.stamina,longW.stamina,t), burst:lerp(shortW.burst,longW.burst,t) };
}
function biasLabel(TD){ if(TD<=2700) return "sprinter-favoring (short)"; if(TD>=3600) return "stamina-favoring (long)"; return "balanced (mid)"; }

/* ===== State ===== */
var state={
  players:[],startBalance:1000,round:1,order:[],horses:[],picks:[],roundDeltas:[],
  race:{duration:20000,trackDistance:3200,runoff:110,t0:0,raf:0,started:false,finished:false,worldHeight:0,padTop:24,padBot:24,rankCounter:1,sprites:[],results:[],venue:null,cond:null,varF:1.0},
  eliminatedLastRound:[]
};
var screens={players:$('#screen-players'),select:$('#screen-select'),race:$('#screen-race'),results:$('#screen-results')};
function show(k){Object.keys(screens).forEach(key=>screens[key].classList.add('hidden')); screens[k].classList.remove('hidden');}

/* ===== Players UI ===== */
var startBalanceEl=$('#startBalance'), startBalanceShow=$('#startBalanceShow'), playerName=$('#playerName'), playerList=$('#playerList');
function updateStartEnabled(){ $('#startGame').disabled = (state.players.filter(p=>p.active).length < 2); }
$('#resetAll').onclick=fullReset;
$('#addPlayer').onclick=()=>addFromInput();
playerName.addEventListener('keydown', e=>{ if(e.key==='Enter') addFromInput(); });
function addFromInput(){
  var n=(playerName.value||'').trim(); if(!n) return;
  addPlayer(n); playerName.value=''; renderPlayers(); updateStartEnabled();
}
$$('.quick').forEach(b=>{
  b.onclick=function(){
    var N=+b.dataset.n;
    while(state.players.length<N){
      var idx = state.players.length % DEFAULT_NAMES.length;
      addPlayer(DEFAULT_NAMES[idx] + (state.players.length>=DEFAULT_NAMES.length ? ' ' + (state.players.length+1) : ''));
    }
    renderPlayers(); updateStartEnabled();
  };
});
startBalanceEl.oninput=function(){var v=Math.max(100,+startBalanceEl.value||1000); state.startBalance=v; startBalanceShow.textContent=fmt(v);};
function addPlayer(name){
  if(state.players.length>=6)return;
  var color=PLAYER_COLORS[state.players.length%PLAYER_COLORS.length];
  state.players.push({id:uid(),name:name,balance:state.startBalance,initialBalance:state.startBalance,active:true,color:color});
}
function removePlayer(id){ state.players=state.players.filter(p=>p.id!==id); }
function renderPlayers(){
  playerList.innerHTML='';
  state.players.forEach(function(p){
    var li=document.createElement('li');
    li.innerHTML='<div class="row" style="justify-content:space-between">'
      +'<div class="row" style="gap:8px;align-items:center">'
      +'<span style="width:14px;height:14px;border-radius:50%;display:inline-block;background:'+p.color+';border:1px solid rgba(0,0,0,.35)"></span>'
      +'<strong>'+esc(p.name)+'</strong>'
      +'<span class="badge">Balance: <span class="money">'+fmt(p.balance)+'</span></span>'
      +'</div>'
      +'<button class="ghost rmv" data-id="'+p.id+'" type="button">Remove</button>'
      +'</div>';
    playerList.appendChild(li);
  });
  $$('#playerList .rmv').forEach(b=>b.onclick=()=>{ removePlayer(b.dataset.id); renderPlayers(); updateStartEnabled(); });
  updateStartEnabled();
}
$('#startGame').onclick=function(){ state.round=1; startRound(); };
renderPlayers();

/* ===== Selection ===== */
var selectMeta=$('#selectMeta');
var turnBanner=$('#turnBanner'), currentPlayerName=$('#currentPlayerName'), currentPlayerBalance=$('#currentPlayerBalance');
var horseGrid=$('#horseGrid'), pickList=$('#pickList'), lockPick=$('#lockPick'), beginRace=$('#beginRace');
$('#backToPlayers').onclick=function(){show('players')};
var turnIdx=0, selHorseId=null;

/* Bet buttons */
var betAmountShow=$('#betAmountShow');
var betAmt=0;
function setBetAmt(newAmt){
  var pid=state.order[turnIdx], p=state.players.find(x=>x.id===pid);
  var max=(p?p.balance:0);
  betAmt=clamp(newAmt,0,max);
  betAmountShow.textContent=fmt(betAmt);
  updatePreview();
}
$('#betPlus50').onclick=function(){ setBetAmt(betAmt+50); };
$('#betPlus100').onclick=function(){ setBetAmt(betAmt+100); };
$('#betAllIn').onclick=function(){ var pid=state.order[turnIdx], p=state.players.find(x=>x.id===pid); setBetAmt(p?p.balance:0); };
$('#betReset').onclick=function(){ setBetAmt(0); };
function getBetType(){var el=document.querySelector('input[name="betType"]:checked'); return el?el.value:'win';}
$$('input[name="betType"]').forEach(r=>r.addEventListener('change', updatePreview));

function startRound(){
  state.picks=[];

  // venue + condition
  var v = VENUE_DATA[rndi(0, VENUE_DATA.length-1)];
  state.race.venue = v.name;
  state.race.trackDistance = v.dist;
  state.race.cond = CONDITIONS[rndi(0, CONDITIONS.length-1)];
  state.race.varF = conditionVariance(state.race.cond);

  state.order=shuffle(state.players.filter(p=>p.active).map(p=>p.id));
  state.horses=genHorses(6, state.race.trackDistance, state.race.varF);
  state.horses.sort((a,b)=>a.odds.win - b.odds.win);

  var metaSel = state.race.venue + ' • ' + state.race.cond + ' • ' + state.race.trackDistance + 'm — ' + biasLabel(state.race.trackDistance);
  if(selectMeta) selectMeta.textContent = metaSel;
  var metaRace=$('#raceMeta');
  if(metaRace) metaRace.textContent = state.race.venue + ' • ' + state.race.cond + ' • ' + state.race.trackDistance + 'm';

  Object.assign(state.race,{finished:false,results:[],rankCounter:1,started:false});
  renderSelect(); show('select'); turnIdx=0; prepTurn();
}
function genHorses(n, TD, varF){
  var colors=['var(--lane1)','var(--lane2)','var(--lane3)','var(--lane4)','var(--lane5)','var(--lane6)']; var names=sampleNames(n);
  var w = distanceWeights(TD);
  return Array.from({length:n},(_,i)=>{
    var speed=clamp(randn(0.65,0.15),0.35,1),
        stamina=clamp(randn(0.65,0.15),0.35,1),
        burst=clamp(randn(0.65,0.15),0.35,1);
    var q = speed*w.speed + stamina*w.stamina + burst*w.burst;
    var baseSec = rnd(19.2,21.5) - (q-0.65)*2.0;
    baseSec *= (TD/3200);
    baseSec += (varF-1) * rnd(-0.6,0.6);
    var minT = 16.8*(TD/3200), maxT = 25.5*(TD/3200);
    var finishTime = clamp(baseSec, minT, maxT)*1000;
    var win = clamp(1.6 + (1-q)*2.4 + rnd(0,0.4)*(0.7 + 0.6*(varF-0.9)), 1.4, 4.8);
    var place = clamp(win*rnd(0.5,0.7), 1.2, Math.max(1.2, win*0.88));
    return {id:uid(),name:names[i],color:colors[i],stats:{speed:speed,stamina:stamina,burst:burst,q:q},finishTime:finishTime,odds:{win:win,place:place}};
  });
}
function sampleNames(n){var pool=REAL_NAMES.slice(), out=[]; while(out.length<n&&pool.length){out.push(pool.splice(rndi(0,pool.length-1),1)[0]);} return out.slice(0,n);}

function renderSelect(){
  horseGrid.innerHTML='';
  state.horses.forEach(function(h){
    var c=document.createElement('div'); c.className='card'; c.style.cursor='pointer'; c.dataset.hid=h.id;
    c.innerHTML='<div class="row" style="align-items:flex-start;gap:10px">'
      +'<div class="icon" style="width:36px;height:28px;background:'+h.color+';animation:none"></div>'
      +'<div style="flex:1">'
      +'<div style="font-weight:700">'+esc(h.name)+'</div>'
      +'<div class="statRow"><span class="statBall s-speed"></span><span class="statName">Speed</span><div class="meter"><span style="width:'+Math.round(h.stats.speed*100)+'%"></span></div></div>'
      +'<div class="statRow"><span class="statBall s-stam"></span><span class="statName">Stamina</span><div class="meter stam"><span style="width:'+Math.round(h.stats.stamina*100)+'%"></span></div></div>'
      +'<div class="statRow"><span class="statBall s-burst"></span><span class="statName">Burst</span><div class="meter burst"><span style="width:'+Math.round(h.stats.burst*100)+'%"></span></div></div>'
      +'<div class="odds"><span class="chip">Win <strong>'+h.odds.win.toFixed(2)+'x</strong></span><span class="chip">Place <strong>'+h.odds.place.toFixed(2)+'x</strong></span></div>'
      +'</div></div>';
    c.onclick=function(){selectHorse(h.id)}; horseGrid.appendChild(c);
  });
  renderPicks();
}
function prepTurn(){
  if(turnIdx>=state.order.length){beginRace.disabled=false;turnBanner.classList.add('hidden');return;}
  beginRace.disabled=true; turnBanner.classList.remove('hidden'); selHorseId=null; lockPick.disabled=true;
  var pid=state.order[turnIdx], p=state.players.find(x=>x.id===pid);
  currentPlayerName.textContent=p.name; currentPlayerBalance.textContent=fmt(p.balance);
  setBetAmt(0); $('#pickPreview').textContent='';
  $$('#horseGrid .card').forEach(e=>e.style.outline='1px solid rgba(255,255,255,.08)');
}
function selectHorse(id){selHorseId=id; $$('#horseGrid .card').forEach(e=>e.style.outline=(e.dataset.hid===id?'2px solid var(--accent)':'1px solid rgba(255,255,255,.08)')); updatePreview();}
function updatePreview(){
  var pid=state.order[turnIdx], p=state.players.find(x=>x.id===pid);
  if(!selHorseId || !p){lockPick.disabled=true; $('#pickPreview').textContent=''; return;}
  var h=state.horses.find(x=>x.id===selHorseId), t=getBetType(), m=t==='win'?h.odds.win:h.odds.place;
  $('#pickPreview').textContent=p.name+' → '+h.name+' • '+t.toUpperCase()+' • '+fmt(betAmt)+' @ '+m.toFixed(2)+'x';
  lockPick.disabled = !(betAmt>=1 && !!selHorseId);
}
lockPick.onclick=function(){
  var pid=state.order[turnIdx], p=state.players.find(x=>x.id===pid);
  if(!selHorseId||betAmt<1||!p)return;
  state.picks.push({playerId:p.id,horseId:selHorseId,type:getBetType(),amount:betAmt});
  p.balance-=betAmt;
  turnIdx++; renderPicks(); prepTurn();
};
function renderPicks(){
  pickList.innerHTML='';
  state.order.forEach(function(pid){
    var p=state.players.find(x=>x.id===pid), pick=state.picks.find(x=>x.playerId===pid);
    var li=document.createElement('li'); li.innerHTML=pick?('<strong>'+esc(p.name)+'</strong> → <span class="pill">'+esc(state.horses.find(x=>x.id===pick.horseId).name)+'</span> • <span class="badge">'+pick.type.toUpperCase()+'</span> • <span class="money">'+fmt(pick.amount)+'</span>'):('<strong>'+esc(p.name)+'</strong> is choosing…'); pickList.appendChild(li);
  });
}
$('#beginRace').onclick=function(){setupRace(); show('race'); beginCountdown();};
$('#skipToResults').onclick=function(){endRace(true)};

/* ===== Race Setup & Loop ===== */
var viewport=$('#viewport'), world=$('#world'), laneGuides=$('#laneGuides'), splits=$('#splits'), bg=$('#bg'), finishLine=$('#finishLine'), gateEl=$('#gate');
var toast=$('#toast'), countdownEl=$('#countdown'), countNum=$('#countNum'), confetti=document.getElementById('confetti'), cfx=confetti.getContext('2d');

function calcLaneGeometry(){
  var inner=document.getElementById('bg').getBoundingClientRect().width;
  var iconW=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--horse-w'))||44;
  var minReserve=160, minSpacing=iconW*1.05, maxSpacing=iconW*1.40;
  var base=(inner - minReserve)/6;
  var spacing = Math.max(minSpacing, Math.min(maxSpacing, base));
  var usable = spacing*6;
  var reserveRight = Math.max(0, inner - usable);
  var leftPad = 12 + spacing/2;
  return {leftPad:leftPad,laneSpacing:spacing,inner:inner,reserve:reserveRight,iconW:iconW};
}
function setupRace(){
  world.innerHTML=''; world.appendChild(bg); world.appendChild(laneGuides); world.appendChild(splits); world.appendChild(finishLine); world.appendChild(gateEl);
  confetti.classList.remove('show'); confetti.width=innerWidth; confetti.height=innerHeight; toast.classList.add('hidden');
  var TD=state.race.trackDistance, padTop=state.race.padTop, padBot=state.race.padBot, worldH=TD+padTop+padBot;
  state.race.worldHeight=worldH; world.style.height=worldH+'px'; bg.style.top='0px'; bg.style.height=worldH+'px'; gateEl.style.top=padTop+'px'; finishLine.style.top=(padTop+TD)+'px';
  splits.innerHTML=''; [0.25,0.5,0.75].forEach(function(f){var y=padTop+TD*f; var s=document.createElement('div'); s.className='split'; s.style.top=y+'px'; var lab=document.createElement('label'); lab.textContent=Math.round(f*100)+'%'; s.appendChild(lab); splits.appendChild(s);});
  laneGuides.innerHTML='';
  var geom=calcLaneGeometry(); var leftPad=geom.leftPad, laneSpacing=geom.laneSpacing;
  for(var i=0;i<6;i++){var x=leftPad+i*laneSpacing; var g=document.createElement('div'); g.className='laneLine'; g.style.left=x+'px'; laneGuides.appendChild(g);}
  var startBehind=16;
  state.race.sprites=state.horses.map(function(h,i){
    var el=document.createElement('div'); el.className='horse'; el.dataset.hid=h.id;
    var x=leftPad+i*laneSpacing - geom.iconW/2; el.style.left=x+'px'; el.style.top=padTop+'px';
    var icon=document.createElement('div'); icon.className='icon'; icon.style.background=h.color;
    var pins=document.createElement('div'); pins.className='pins'; icon.appendChild(pins);
    var tag=document.createElement('div'); tag.className='tag';
    tag.innerHTML='<span class="pos" data-pos>—</span><span class="hName"><span class="hInner">'+esc(h.name)+'</span></span>';
    tag.style.transform='translateX(12px)';
    tag.style.maxWidth = Math.max(140, geom.reserve - 16) + 'px';
    el.appendChild(icon); el.appendChild(tag); world.appendChild(el);
    var nameWrap = tag.querySelector('.hName'), nameInner = tag.querySelector('.hInner');
    var S={
      h:h,el:el,icon:icon,pins:pins,tag:tag,nameWrap:nameWrap,nameInner:nameInner,
      y:-startBehind,crossed:false,offtrack:false,crossTime:null,rank:null,
      posEl:tag.querySelector('[data-pos]'),vBase:TD/(h.finishTime/1000),plan:pacePlan(h, TD, state.race.varF)
    };
    el.style.transform='translate(0,'+S.y+'px)';
    return S;
  });
  var byHorse=groupBy(state.picks,'horseId');
  state.race.sprites.forEach(function(S){
    S.pins.innerHTML='';
    var arr=byHorse[S.h.id]||[];
    arr.slice(0,4).forEach(function(pk){
      var p=state.players.find(pp=>pp.id===pk.playerId);
      var ic=document.createElement('span'); ic.className='picon'; ic.textContent=initials(p.name); ic.style.background=p.color; S.pins.appendChild(ic);
    });
    if(arr.length>4){
      var m=document.createElement('span'); m.className='picon'; m.textContent='+'+(arr.length-4); m.style.background='#b9d3e0'; S.pins.appendChild(m);
    }
  });
  state.race.sprites.forEach(applyNameScroll);
  window.onresize=function(){
    var g=calcLaneGeometry();
    $$('#laneGuides .laneLine').forEach((line,idx)=>{ line.style.left=(g.leftPad+idx*g.laneSpacing)+'px'; });
    state.race.sprites.forEach(function(S,i){
      var nx=g.leftPad+i*g.laneSpacing-g.iconW/2; S.el.style.left=nx+'px';
      S.tag.style.maxWidth = Math.max(140, g.reserve - 16) + 'px';
      applyNameScroll(S);
    });
  };
}
function applyNameScroll(S){
  var wrap=S.nameWrap, inner=S.nameInner; if(!wrap || !inner) return;
  var cw = wrap.clientWidth, sw = inner.scrollWidth;
  if(sw > cw){
    wrap.classList.add('scroll');
    inner.style.setProperty('--scrollX', (sw - cw + 8) + 'px');
    var dur = Math.max(6, Math.min(14, (sw/cw)*6));
    inner.style.setProperty('--dur', dur + 's');
  }else{
    wrap.classList.remove('scroll');
    inner.style.removeProperty('--scrollX'); inner.style.removeProperty('--dur');
  }
}
function pacePlan(h, TD, varF){
  var T=h.finishTime;
  var stops=[0,5000,10000,15000,Math.max(18500,T-2500),T];
  var spread = 0.06 * varF;
  var mul=Array(stops.length-1).fill(0).map(()=>rnd(1-spread,1+spread));
  var isShort = TD<=2700, isLong = TD>=3600;
  var a = isShort ? rndi(1,2) : isLong ? rndi(2,4) : rndi(1,3);
  var b = isShort ? rndi(1,3) : isLong ? rndi(3,4) : rndi(2,4);
  mul[a]*=rnd(1.10,1.22); mul[b]*=rnd(1.08,1.18);
  mul[2]*=(0.94+h.stats.stamina*0.12);
  return {stops:stops,mul:mul};
}
function seg(stops,t){for(var i=0;i<stops.length-1;i++){if(t>=stops[i]&&t<stops[i+1])return i}return stops.length-2}

/* ===== Countdown / Audio ===== */
var gallopAudio,cheerAudio,gatesAudio;
function makeWavBase64FromFloat32(samples,sr,nc){sr=sr||22050; nc=nc||1; var b=new ArrayBuffer(44+samples.length*2),v=new DataView(b);function w(o,s){for(var i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}
 w(0,'RIFF');v.setUint32(4,36+samples.length*2,true);w(8,'WAVE');w(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,nc,true);v.setUint32(24,sr,true);v.setUint32(28,sr*nc*2,true);v.setUint16(32,nc*2,true);v.setUint16(34,16,true);w(36,'data');v.setUint32(40,samples.length*2,true);var i=44;for(var j=0;j<samples.length;j++){var s0=samples[j];var s=Math.max(-1,Math.min(1,s0));v.setInt16(i,s<0?s*0x8000:s*0x7FFF,true);i+=2;}var bin='';var bytes=new Uint8Array(b);for(var k=0;k<bytes.length;k++)bin+=String.fromCharCode(bytes[k]);return btoa(bin);}
function buildGateSound(){var sr=22050,d=0.25,N=Math.floor(sr*d),a=new Float32Array(N);for(var i=0;i<N;i++){var t=i/sr,env=Math.exp(-12*t),f=140+60*Math.exp(-8*t);a[i]=env*Math.sin(2*Math.PI*f*t);}return new Audio('data:audio/wav;base64,'+makeWavBase64FromFloat32(a));}
function buildGallopLoop(){var sr=22050,d=0.6,N=Math.floor(sr*d),a=new Float32Array(N),beats=[0,0.12,0.24,0.40];for(var i=0;i<N;i++){var t=i/sr;var v=0;for(var bi=0;bi<beats.length;bi++){var b=beats[bi];var dt=(t-b+d)%d;v+=Math.exp(-60*dt)*Math.sin(2*Math.PI*110*t)*0.45;}v+=0.08*Math.sin(2*Math.PI*55*t);a[i]=v*0.8;}var A=new Audio('data:audio/wav;base64,'+makeWavBase64FromFloat32(a));A.loop=true;return A;}
function buildCheer(){var sr=22050,d=1.8,N=Math.floor(sr*d),a=new Float32Array(N);var r=1;for(var i=0;i<N;i++){var t=i/sr;r=(r*16807)%2147483647;var n=(r/2147483647)*2-1,env=Math.min(1,Math.max(0,1.2*Math.exp(-1.2*(t-0.2)))),tone=0.15*Math.sin(2*Math.PI*(220+20*Math.sin(2*Math.PI*1.5*t))*t);a[i]=0.6*n*env+tone*env;}return new Audio('data:audio/wav;base64,'+makeWavBase64FromFloat32(a));}
var audioMuted = (localStorage.getItem('pf_mute')==='1');
var muteBtn = $('#muteBtn');
function ensureAudio(){ if(!gatesAudio) gatesAudio = buildGateSound(); if(!gallopAudio) gallopAudio = buildGallopLoop(); if(!cheerAudio)  cheerAudio  = buildCheer(); syncMuteState(); }
function syncMuteState(){ [gallopAudio,gatesAudio,cheerAudio].forEach(a=>{ if(a){ a.muted = !!audioMuted; }}); muteBtn.setAttribute('aria-pressed', audioMuted?'true':'false'); muteBtn.textContent = audioMuted ? '🔇 Muted' : '🔊 Sound'; }
muteBtn.onclick=function(){ ensureAudio(); audioMuted = !audioMuted; localStorage.setItem('pf_mute', audioMuted?'1':'0'); syncMuteState(); try{ if(audioMuted&&gallopAudio) gallopAudio.pause(); }catch(e){} };
window.addEventListener('DOMContentLoaded', function(){ ensureAudio(); syncMuteState(); });

function beginCountdown(){
  var c=$('#countdown'), n=$('#countNum'); c.classList.remove('hidden'); n.className='countText'; var k=3; n.textContent=k;
  function tick(){k--; if(k>0){n.textContent=k; setTimeout(tick,1000);} else {n.textContent='GO!'; n.className='countGo'; playGates(); setTimeout(function(){c.classList.add('hidden'); startRace();},320);} }
  setTimeout(tick,1000);
}
function playGates(){ensureAudio();try{gatesAudio.currentTime=0;gatesAudio.play();}catch(e){}}
function playGallop(){ensureAudio();try{gallopAudio.currentTime=0;gallopAudio.play();}catch(e){}}
function stopGallop(){try{gallopAudio.pause();}catch(e){}}
function playCheer(){ensureAudio();try{cheerAudio.currentTime=0;cheerAudio.play();}catch(e){}}

/* ===== Race loop ===== */
var camY=0,lastTs=0,winnerAnnounced=false,slowMo=false;
var prevLeaderId=null,lastCheerTime=0;
var LEAD_CHEER_GAP=48;
var CHEER_COOLDOWN=1500;

function startRace(){
  $('#gate').classList.add('open'); state.race.t0=performance.now(); state.race.finished=false; state.race.started=true; winnerAnnounced=false; slowMo=false; playGallop();
  var vpH=viewport.clientHeight; camY=0; world.style.transform='translateY(' + (-camY) + 'px)'; lastTs=state.race.t0;
  function frame(now){
    var t=now-state.race.t0; var dt=(now-lastTs)/1000; if(dt>0.06)dt=0.06; lastTs=now;
    var TD=state.race.trackDistance; var leaderDist=Math.max.apply(null,state.race.sprites.map(S=>S.y));
    var pack=state.race.sprites.slice().sort((a,b)=>b.y-a.y);
    if(!slowMo && leaderDist>TD*0.92){var d12=(pack[0]?pack[0].y:0)-(pack[1]?pack[1].y:0); if(d12<45){slowMo=true;}}
    if(slowMo) dt*=0.35;

    var allOff=true;
    for(var S of state.race.sprites){
      if(S.offtrack) continue;
      var segIdx=seg(S.plan.stops,t); var v=S.vBase*S.plan.mul[segIdx]; v*=(1+0.02*Math.sin((t/1000)*(1.2+S.h.stats.burst*1.6))); S.y+=v*dt;
      var lastI=S.plan.stops.length-2; if(segIdx===lastI){var rt=(S.h.finishTime-t)/1000, rd=TD-S.y; if(rt>0){v=v*0.5+(rd/rt)*0.5; S.y+=v*dt;}}
      if(!S.crossed && S.y>=TD){S.crossed=true; S.crossTime=t; S.rank=state.race.rankCounter++; state.race.results.push({horseId:S.h.id,finishTime:S.crossTime,rank:S.rank});
        if(S.rank===1 && !winnerAnnounced){winnerAnnounced=true; toast.textContent=S.h.name+' hits the line first!'; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'),2200);}}
      if(S.y>=TD+state.race.runoff){S.y=TD+state.race.runoff; S.offtrack=true;} else {allOff=false;}
      S.el.style.transform='translate(0,'+S.y+'px)';
    }

    var live=state.race.sprites.slice().sort((a,b)=>b.y-a.y);
    state.race.sprites.forEach(S=>S.el.classList.remove('top1','top2','top3','leaderGlow'));
    live.forEach(function(S,i){
      if(i===0)S.el.classList.add('top1','leaderGlow');
      else if(i===1)S.el.classList.add('top2');
      else if(i===2)S.el.classList.add('top3');
      S.posEl.textContent=ordinal(i+1);
    });

    var leader=live[0], second=live[1];
    if(leader){
      var nowMs=now;
      if(prevLeaderId!==null && leader.h.id!==prevLeaderId){
        var gap=(second? (leader.y - second.y) : 999);
        if(gap>=LEAD_CHEER_GAP && (nowMs-lastCheerTime)>=CHEER_COOLDOWN){ playCheer(); lastCheerTime=nowMs; }
      }
      prevLeaderId=leader.h.id;
    }

    var vpH2=viewport.clientHeight; var maxCam=Math.max(0,state.race.worldHeight-vpH2);
    var leaderWorldY=state.race.padTop+leader.y; var target=clamp(leaderWorldY - vpH2*0.60, 0, maxCam);
    camY += (target - camY) * 0.14; var leaderScreenY=leaderWorldY - camY;
    if(leaderScreenY < vpH2*0.35) camY = clamp(leaderWorldY - vpH2*0.35, 0, maxCam);
    if(leaderScreenY > vpH2*0.75) camY = clamp(leaderWorldY - vpH2*0.75, 0, maxCam);
    world.style.transform='translateY(' + (-camY) + 'px)';

    if(allOff || t >= state.race.duration + 4000){ endRace(false); return; }
    state.race.raf=requestAnimationFrame(frame);
  }
  state.race.raf=requestAnimationFrame(frame);
}

/* ===== End / settle / results ===== */
var roundBanner=$('#roundBanner'), podium=$('#podium'), orderList=$('#orderList'), playerOutcomes=$('#playerOutcomes');
function endRace(skip){
  if(state.race.finished) return; state.race.finished=true; if(state.race.raf) cancelAnimationFrame(state.race.raf); stopGallop();
  var TD=state.race.trackDistance;
  if(skip){
    var order=state.race.sprites.slice().sort((a,b)=>b.y-a.y);
    order.forEach(function(S,i){if(!S.crossed){S.crossed=true;S.crossTime=20000+i*100;S.rank=state.race.rankCounter++;state.race.results.push({horseId:S.h.id,finishTime:S.crossTime,rank:S.rank});}
      S.y=TD+state.race.runoff; S.offtrack=true; S.el.style.transform='translate(0,'+S.y+'px)';});
  } else {
    var remain=state.race.sprites.filter(s=>!s.crossed).sort((a,b)=>b.y-a.y);
    if(remain.length){
      var lastRec = state.race.results.length ? state.race.results[state.race.results.length-1] : null;
      var base=(lastRec && lastRec.finishTime) ? lastRec.finishTime : 20000;
      remain.forEach(function(S,i){S.crossed=true;S.crossTime=base+100+i*50;S.rank=state.race.rankCounter++;state.race.results.push({horseId:S.h.id,finishTime:S.crossTime,rank:S.rank});S.y=TD+state.race.runoff;S.offtrack=true;S.el.style.transform='translate(0,'+S.y+'px)';});
    }
  }
  $('#raceShell').classList.add('fadeTrack');
  settle();
  renderResults();
  show('results');
}

function settle(){
  var order=state.race.results.slice().sort((a,b)=>a.rank-b.rank).map(r=>r.horseId);
  var first=order[0], top3=new Set(order.slice(0,3));
  state.roundDeltas=state.players.map(p=>({playerId:p.id,name:p.name,color:p.color,won:0,staked:0,net:0,wonOn:[]}));
  state.picks.forEach(function(pk){
    var h=state.horses.find(x=>x.id===pk.horseId), p=state.players.find(x=>x.id===pk.playerId), rec=state.roundDeltas.find(r=>r.playerId===p.id);
    rec.staked+=pk.amount; var win=0; if(pk.type==='win'&&pk.horseId===first){win=pk.amount*h.odds.win;rec.wonOn.push(h.name);} else if(pk.type==='place'&&top3.has(pk.horseId)){win=pk.amount*h.odds.place;rec.wonOn.push(h.name);}
    if(win>0){var w=Math.floor(win); p.balance+=w; rec.won+=w;} pk.win=Math.floor(win); pk.result=win>0?'WIN':'LOSE';
  });
  state.roundDeltas.forEach(r=>r.net=r.won-r.staked);

  // mark eliminations (AFTER race is settled)
  var elim=[];
  state.players.forEach(function(p){
    if(p.active && p.balance<=0){
      p.balance=0;
      p.active=false;
      elim.push(p);
    }
  });
  state.eliminatedLastRound = elim;
}

$('#nextRound').onclick=function(){ state.round++; startRound(); };
$('#leavePlayers').onclick=function(){ state.players=state.players.filter(p=>p.balance>0); if(state.players.filter(p=>p.active).length<2){alert('Not enough players.'); fullReset(); return;} state.round++; startRound(); };
$('#fullReset').onclick=fullReset;

function renderResults(){
  var ord=state.race.results.slice().sort((a,b)=>a.rank-b.rank), winnerHorse=state.horses.find(h=>h.id===ord[0].horseId);
  var winners=state.roundDeltas.filter(r=>r.wonOn.indexOf(winnerHorse.name)!==-1), topNet=state.roundDeltas.slice().sort((a,b)=>b.net-a.net)[0];

  roundBanner.classList.remove('hidden');
  var elimText = state.eliminatedLastRound.length ? (' <span class="lossBadge">Eliminated: '+state.eliminatedLastRound.map(p=>esc(p.name)).join(', ')+'</span>') : '';
  roundBanner.innerHTML='<span class="winBadge">Winner: '+esc(winnerHorse.name)+'</span>'
    +(winners.length?winners.map(w=>'<span class="winBadge" style="background:#1f6b3c;border-color:#2da760">+'+(w.net>0?fmt(w.net):fmt(w.won))+' '+esc(w.name)+'</span>').join(''):'<span class="lossBadge">No winning tickets</span>')
    +' <span class="'+(topNet.net>=0?'winBadge':'lossBadge')+'">Top net: '+esc(topNet.name)+' '+(topNet.net>=0?'+':'')+fmt(topNet.net)+'</span>'
    + elimText;

  var medals=['🥇','🥈','🥉']; podium.innerHTML='';
  ord.slice(0,3).forEach(function(o,i){var h=state.horses.find(x=>x.id===o.horseId); var d=document.createElement('div'); d.className='kpi';
    d.innerHTML='<div class="row" style="gap:8px"><span style="font-size:1.25rem">'+medals[i]+'</span><div class="icon" style="width:18px;height:14px;background:'+h.color+';animation:none"></div><strong>'+esc(h.name)+'</strong></div><div class="small">Time: '+(o.finishTime/1000).toFixed(2)+'s</div>'; podium.appendChild(d);});

  orderList.innerHTML=''; ord.forEach(function(o){var h=state.horses.find(x=>x.id===o.horseId); var bettors=state.picks.filter(pk=>pk.horseId===o.horseId).map(pk=>state.players.find(p=>p.id===pk.playerId).name);
    var li=document.createElement('li'); li.innerHTML='<div class="row" style="justify-content:space-between"><div class="row" style="gap:8px"><div class="badge">#'+o.rank+'</div><div class="icon" style="width:18px;height:14px;background:'+h.color+';animation:none"></div><strong>'+esc(h.name)+'</strong></div><div class="small">'+(bettors.length?('Picked by: '+bettors.map(esc).join(', ')):'No picks')+'</div></div>'; orderList.appendChild(li);});

  playerOutcomes.innerHTML='';
  var by=groupBy(state.picks,'playerId');
  state.players.forEach(function(p){
    var arr=by[p.id]||[], delta=state.roundDeltas.find(d=>d.playerId===p.id)||{net:0};
    var rows=arr.length?arr.map(function(pk){var h=state.horses.find(x=>x.id===pk.horseId); return '<div class="row" style="justify-content:space-between"><div>'+pk.type.toUpperCase()+' • <span class="pill">'+esc(h.name)+'</span> • <span class="small">'+fmt(pk.amount)+' bet</span></div><div class="'+(pk.win>0?'money':'')+'">'+pk.result+' '+(pk.win>0?('+ '+fmt(pk.win)):' ')+'</div></div>';}).join(''):'<div class="small">No bets this round.</div>';
    var li2=document.createElement('li');
    li2.dataset.pid=p.id;
    li2.className = (p.active?'':'eliminated');
    li2.innerHTML='<div class="row" style="justify-content:space-between"><div class="row" style="gap:8px"><span style="width:14px;height:14px;border-radius:50%;display:inline-block;background:'+p.color+';border:1px solid rgba(0,0,0,.35)"></span><strong>'+esc(p.name)+'</strong></div><div>Balance: <span class="money">'+fmt(p.balance)+'</span> <span class="'+(delta.net>=0?'winBadge':'lossBadge')+'" style="margin-left:6px">'+(delta.net>=0?'+':'')+fmt(delta.net)+'</span></div></div><div class="card" style="margin-top:8px">'+rows+'</div>';
    playerOutcomes.appendChild(li2);
  });

  // Kick off elimination sequence (blocks until finished), then maybe show champion
  runEliminationFlow();
}

/* ===== Elimination sequence (after race only) ===== */
function runEliminationFlow(){
  var elim = state.eliminatedLastRound.slice();
  if(!elim.length){ checkChampion(true); return; }

  // lock buttons until sequence completes
  $('#nextRound').disabled=true; $('#leavePlayers').disabled=true;

  var modal=$('#koModal'), body=$('#koBody'), btn=$('#koNext');
  var i=0;
  function showOne(){
    if(i>=elim.length){
      modal.classList.add('hidden');
      state.eliminatedLastRound=[];
      checkChampion(true);
      return;
    }
    var p=elim[i];
    body.innerHTML='<div style="font-size:1.1rem;margin-bottom:6px"><strong>'+esc(p.name)+'</strong></div>'
                  +'<div class="small">Balance: 0</div>'
                  +'<div style="margin-top:6px">Game over — you’re out.</div>';
    modal.classList.remove('hidden');
    btn.onclick=function(){ modal.classList.add('hidden'); i++; setTimeout(showOne,200); };
  }
  showOne();
}
function checkChampion(reenableButtons){
  var alive = state.players.filter(p=>p.active);
  if(alive.length<=1){
    $('#nextRound').disabled=true; $('#leavePlayers').disabled=true;
    var bodyText;
    if(alive.length===1){
      var champ=alive[0];
      var winnings = champ.balance - (champ.initialBalance||state.startBalance);
      bodyText = '<div style="font-size:1.1rem;margin-bottom:6px"><strong>'+esc(champ.name)+'</strong></div>'
                +'<div class="money" style="font-size:1.15rem">Day’s Winnings: '+(winnings>=0?'+':'')+fmt(winnings)+'</div>';
      runConfetti(6000);
    }else{
      bodyText = '<div>No players remain.</div>';
    }
    $('#champBody').innerHTML = bodyText;
    $('#champModal').classList.remove('hidden');
  }else if(reenableButtons){
    $('#nextRound').disabled=false; $('#leavePlayers').disabled=false;
  }
}

/* Buttons in champion modal */
$('#btnPlayAgain').onclick=function(){
  state.players.forEach(function(p){
    p.balance=state.startBalance;
    p.initialBalance=state.startBalance;
    p.active=true;
  });
  state.round=1; state.order=[]; state.horses=[]; state.picks=[]; state.roundDeltas=[]; state.eliminatedLastRound=[];
  $('#champModal').classList.add('hidden');
  show('select'); startRound();
};
$('#btnBackStart').onclick=function(){ $('#champModal').classList.add('hidden'); fullReset(); };

/* ===== Confetti ===== */
var confettiTimer=null, confettiAnim=null, parts=[];
function runConfetti(ms){ms=ms||5000;parts=Array.from({length:220},()=>({x:Math.random()*confetti.width,y:Math.random()*-confetti.height,r:Math.random()*6+3,vy:Math.random()*2+2,vx:(Math.random()-0.5)*1.2,a:Math.random()*360,va:(Math.random()-0.5)*8,color:'hsl('+(Math.random()*360)+',100%,50%)'})); confetti.classList.add('show');
  function step(){var ctx=cfx; ctx.clearRect(0,0,confetti.width,confetti.height); for(var p of parts){p.x+=p.vx;p.y+=p.vy;p.a+=p.va;if(p.y>confetti.height+20){p.y=-10;p.x=Math.random()*confetti.width;} ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a*Math.PI/180); ctx.fillStyle=p.color; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r); ctx.restore();} confettiAnim=requestAnimationFrame(step);}
  step(); clearTimeout(confettiTimer); confettiTimer=setTimeout(function(){confetti.classList.remove('show'); if(confettiAnim) cancelAnimationFrame(confettiAnim);},ms);
}

/* ===== Reset ===== */
function fullReset(){
  state.players=[];state.round=1;state.order=[];state.horses=[];state.picks=[];state.roundDeltas=[];state.eliminatedLastRound=[];
  state.race={duration:20000,trackDistance:3200,runoff:110,t0:0,raf:0,started:false,finished:false,worldHeight:0,padTop:24,padBot:24,rankCounter:1,sprites:[],results:[],venue:null,cond:null,varF:1.0};
  renderPlayers(); show('players'); updateStartEnabled();
}
</script>
</body>
</html>