<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Finish — Multiplayer Horse Race</title>
  <style>
    :root{
      --ink:#0b1f2a; --paper:#f7f4ee; --accent:#d43d3d; --muted:#6c6e70;
      --win:#1a7f37; --loss:#9b1c1c; --rail:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--paper)}
    header{padding:12px 16px;background:#fff;border-bottom:1px solid #e6e1d9;position:sticky;top:0;z-index:30;display:flex;justify-content:space-between;align-items:center}
    .status{font-variant-numeric:tabular-nums}
    .screen{padding:12px 12px 96px;max-width:860px;margin:0 auto}
    .section{font-size:12px;letter-spacing:.04em;color:var(--muted);text-transform:uppercase;margin:10px 2px}
    .row{display:flex;gap:8px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}.btn{padding:10px 14px;border:1px solid #dcd7cf;border-radius:12px;background:#fff;cursor:pointer}
.btn.primary{background:var(--ink);color:#fff;border-color:var(--ink);box-shadow:0 6px 18px rgba(11,31,42,.18)}
.btn.ghost{background:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}

input[type="text"],input[type="number"],select{width:100%;padding:12px;border:1px solid #dcd7cf;border-radius:10px;background:#fff;font:inherit}
.card{border:1px solid #e6e1d9;border-radius:16px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.05)}

/* Draft grid */
.horses{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:560px){.horses{grid-template-columns:1fr 1fr}}
.horse-card{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;padding:12px}
.horse-card.selected{outline:2px solid var(--ink)}
.badge{font-weight:700;border:1px solid #e6e1d9;border-radius:10px;padding:4px 8px;min-width:74px;text-align:center}
.sub{font-size:12px;color:var(--muted)}

/* Bottom bar */
.dock{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,#f7f4eecc,var(--paper));border-top:1px solid #e6e1d9;padding:10px 12px;z-index:40}
.dock-row{display:flex;gap:8px;flex-wrap:wrap}

/* Straight track */
.track-wrap{border:1px solid #e6e1d9;border-radius:16px;background:linear-gradient(#dff1ff 0 42%, #bdd8f3 42% 43%, #cfe9cf 43%);box-shadow:inset 0 6px 40px rgba(0,0,0,.05);padding:12px}
.track{position:relative;overflow:hidden;border-radius:12px;background:linear-gradient(90deg,#faf7f0,#f1eadf)}
.lane{position:relative;display:flex;align-items:center;height:58px;border-top:1px dashed rgba(0,0,0,.06)}
.lane:first-child{border-top:none}
.runner{position:absolute;left:8px;display:flex;align-items:center;gap:8px;transition:transform .08s linear}
.runner .name{font-size:12px;padding:2px 8px;border-radius:999px;background:#fff;border:1px solid #e6e1d9}
.runner .tag{font-size:11px;color:#fff;background:#555;padding:2px 6px;border-radius:6px}
.runner.player .name{border-color:var(--ink);box-shadow:0 0 0 2px rgba(11,31,42,.08)}
.finish{position:absolute;right:12px;top:0;bottom:0;width:6px;background:repeating-linear-gradient(180deg,#fff,#fff 8px,#222 8px,#222 16px);opacity:.9}

/* Overlays */
.countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:56px;color:#fff;text-shadow:0 2px 16px rgba(0,0,0,.35);pointer-events:none}
.announcer{margin-top:8px;font-size:14px}

dialog{border:none;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:16px;max-width:640px}
dialog::backdrop{background:rgba(0,0,0,.35)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
th{font-size:12px;text-transform:uppercase;color:var(--muted)}

  </style>
</head>
<body>
  <header>
    <strong>Photo Finish</strong>
    <div class="status" id="status">Setup</div>
  </header>  <!-- Setup -->  <main class="screen" id="setup">
    <div class="section">Add players</div>
    <div class="card" style="padding:12px">
      <div id="player-list" class="stack"></div>
      <div class="row">
        <input id="new-player" type="text" placeholder="Player name"/>
        <button class="btn" id="add-player">Add</button>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="sub">Starting balance</div>
        <input id="start-balance" type="number" value="1000" min="100" step="50" style="width:120px"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="start-draft" class="btn primary" disabled>Start draft</button>
    </div>
  </main>  <!-- Draft -->  <main class="screen" id="draft" hidden>
    <div class="section"><span id="turn-label">Draft</span></div>
    <div id="horse-grid" class="horses"></div>
    <p class="sub" id="fav-hint" style="margin-top:6px"></p>
  </main>  <!-- Race -->  <main class="screen" id="race" hidden>
    <div class="section">Race — Straight line (≈20s)</div>
    <div class="track-wrap">
      <div class="track" id="track" style="height: calc(58px * 8 + 8px)">
        <div class="countdown" id="countdown"></div>
        <div class="finish"></div>
      </div>
    </div>
    <div class="announcer" id="announcer"></div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="next-race" hidden>Next race</button>
    </div>
  </main>  <!-- Bottom bet dock -->  <div class="dock" id="dock" hidden>
    <div class="dock-row">
      <select id="bet-type" style="flex:0 0 160px">
        <option value="win">Win</option>
        <option value="place">Place (1st/2nd)</option>
      </select>
      <input id="bet-amount" type="number" min="1" placeholder="Bet amount" class="bet" style="flex:1"/>
      <button class="btn" data-chip="25">+25</button>
      <button class="btn" data-chip="50">+50</button>
      <button class="btn" data-chip="100">+100</button>
      <button class="btn" data-chip="ALL">All-in</button>
      <button id="lock-pick" class="btn primary" disabled>Lock pick</button>
      <button id="back-setup" class="btn ghost">Players</button>
    </div>
  </div>  <!-- Results -->  <dialog id="result-modal">
    <h3 id="result-title" style="margin:4px 0 8px">Results</h3>
    <div id="result-body" style="margin-bottom:12px"></div>
    <div class="sub" id="result-sub"></div>
    <div class="row" style="justify-content:flex-end;margin-top:14px">
      <button class="btn" id="again">Next race</button>
      <button class="btn" id="reset">Reset</button>
    </div>
  </dialog><script>
(function(){
  const NUM_LANES = 8;
  const RACE_DURATION = 20000;
  const PLACE_FACTOR = 0.55;

  const state = {
    players: [], // {id,name,balance,betType,bet,horseIndex}
    picks: [],   // per race
    horses: [],
    current: 0,
    order: []
  };

  const el = (id)=>document.getElementById(id);
  const qs = (s)=>document.querySelector(s);
  const fmt = (n)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:0});

  // --------- Setup ---------
  function renderSetup(){
    el('status').textContent='Setup';
    const list = el('player-list'); list.innerHTML='';
    state.players.forEach((p,i)=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<input type="text" value="${p.name}" data-i="${i}"/>
                       <span class="sub">${fmt(p.balance)} credits</span>
                       <button class="btn" data-del="${i}">Remove</button>`;
      row.querySelector('input').addEventListener('input', e=>{ p.name=e.target.value.trim(); });
      row.querySelector('[data-del]').addEventListener('click', ()=>{ state.players.splice(i,1); renderSetup(); updateStartDisabled(); });
      list.appendChild(row);
    });
    updateStartDisabled();
  }
  function updateStartDisabled(){ el('start-draft').disabled = state.players.length<2; }

  el('add-player').addEventListener('click', ()=>{
    const name = el('new-player').value.trim() || `Player ${state.players.length+1}`;
    const bal = Math.max(100, Number(el('start-balance').value||1000));
    state.players.push({id:crypto.randomUUID(), name, balance:bal, betType:'win', bet:0, horseIndex:null});
    el('new-player').value=''; renderSetup();
  });

  el('start-draft').addEventListener('click', ()=>{ startDraft(); });
  el('back-setup').addEventListener('click', ()=>{ show('setup'); });

  // --------- Names / colors / images ---------
  const TITLES=["Sir","Lady","Captain","Saint","Baron","Count","Duke","Doctor","General","Mister","Queen","King","Chief","Major","El","La"];
  const ADJ=["Midnight","Lucky","Crimson","Silver","Velvet","Rapid","Quiet","Neon","Maple","Royal","Rocket","Golden","Storm","River","Cinder","Icy","Amber","Shadow","Copper","Brave","Blue","Scarlet","Ivory","Turbo","Jet","Mellow","Northern","Western","Urban","Wild","Bold","Spry","Swift","Gilded","Rusty","Misty","Solar","Lunar","Pepper","Noble","Bright","Nimble","Prime","Verdant","Granite","Iron","Maritime","Sable","Ruby"];
  const NOUN=["Comet","Whisper","Dash","Valor","Charm","Rider","Phantom","Ember","Voyager","Blaze","Echo","Tempo","Spirit","Horizon","Mirage","Thunder","Quasar","Bandit","Biscuit","Falcon","Clover","Nova","Ranger","Marble","Nimbus","Hustle","Rebel","Monarch","Harbor","Zephyr","Harrier","Beacon","Strider","Oracle","Signal","Pioneer","Vector","Summit","Caper","Riddle","Cipher","Pilot","Anchor"];

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

  function uniqueHorseNames(n){
    // Consume tokens so no overlapping elements across horses
    const t = shuffle([...TITLES]);
    const a = shuffle([...ADJ]);
    const b = shuffle([...NOUN]);
    const names=[]; let ti=0, ai=0, bi=0;
    for(let i=0;i<n;i++){
      const useTitle = Math.random()<0.35 && ti<t.length;
      const title = useTitle ? t[ti++]+' ' : '';
      const adj = a[ai++] || `Unique${i}`;
      const noun = b[bi++] || `Name${i}`;
      names.push((title+adj+' '+noun).trim());
    }
    return names;
  }

  function colorPalette(n){
    const cols=[]; const s=70,l=55;
    for(let i=0;i<n;i++){
      const h = Math.round((360/n)*i + Math.random()*8) % 360;
      cols.push(`hsl(${h} ${s}% ${l}%)`);
    }
    return cols;
  }

  function horseSVG(color, cloth){
    const pattern = [
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><path d="M-4 -8 h26" stroke="#222"/>',
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><circle cx="9" cy="-9" r="4" fill="#222"/>',
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><path d="M-4 -14 l26 14" stroke="#222"/>',
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><path d="M-4 -12 h26" stroke="#222"/><path d="M-4 -10 h26" stroke="#222"/>'
    ][cloth%4];
    return `<?xml version="1.0"?><svg width="56" height="40" viewBox="0 0 140 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <g fill="${color}" stroke="#222" stroke-width="2">
        <ellipse cx="60" cy="60" rx="36" ry="22"/>
        <circle cx="100" cy="58" r="16"/>
        <path d="M108 46 l18 -18 l8 8 l-12 14 z"/>
        <circle cx="112" cy="54" r="2" fill="#000"/>
        <rect x="20" y="70" width="14" height="18" rx="3"/>
        <rect x="58" y="72" width="14" height="18" rx="3"/>
        <rect x="94" y="72" width="14" height="18" rx="3"/>
      </g>
      <g transform="translate(86,76)" stroke="#222">${pattern}</g>
    </svg>`
  }

  // --------- Draft ---------
  function startDraft(){
    state.picks=[]; state.current=0; state.horses = generateHorses(Math.min(NUM_LANES, Math.max(state.players.length+2,6)));
    show('draft'); renderDraft(); el('dock').hidden=false; el('bet-amount').value=''; el('bet-type').value='win';
  }

  function generateHorses(n){
    const names = uniqueHorseNames(n);
    const colors = colorPalette(n);
    return names.map((name,i)=>{
      const speed = 60 + Math.random()*40;    // top
      const stamina = 50 + Math.random()*50;  // sustain
      const burst = 40 + Math.random()*60;    // late kick
      const temper = 30 + Math.random()*70;   // wobble
      const score = 0.5*speed + 0.3*stamina + 0.2*burst;
      const odds = Math.max(1.4, Math.round((1/((score)/(n*50)*0.9))*10)/10); // decimal
      return {name,color:colors[i],img:horseSVG(colors[i],i),attr:{speed,stamina,burst,temper},odds,placeOdds:Math.max(1.2,Math.round(odds*PLACE_FACTOR*10)/10)}
    });
  }

  function renderDraft(){
    el('status').textContent='Draft';
    const p = state.players[state.current];
    qs('#turn-label').textContent = `${p.name}: pick your horse & bet`;
    const grid = el('horse-grid'); grid.innerHTML='';

    const favIdx = state.horses.map(h=>1/h.odds).indexOf(Math.max(...state.horses.map(h=>1/h.odds)));
    el('fav-hint').textContent = `Favorite: ${state.horses[favIdx].name} (${state.horses[favIdx].odds.toFixed(2)}x)`;

    state.horses.forEach((h,i)=>{
      const taken = state.picks.some(pk=>pk.horseIndex===i);
      const card = document.createElement('button');
      card.className='card horse-card'; card.type='button'; card.disabled = taken;
      card.innerHTML = `
        <div>${h.img}</div>
        <div>
          <div style="font-weight:700">${h.name}</div>
          <div class="sub">Speed ${h.attr.speed|0} • Stamina ${h.attr.stamina|0} • Burst ${h.attr.burst|0}</div>
        </div>
        <div>
          <div class="badge">${h.odds.toFixed(2)}x</div>
          <div class="sub" style="text-align:center">Place ${h.placeOdds.toFixed(2)}x</div>
        </div>`;
      card.addEventListener('click',()=>selectHorse(i, card));
      grid.appendChild(card);
    });

    updateLock();
  }

  function selectHorse(i, card){
    state.players[state.current].horseIndex = i;
    document.querySelectorAll('.horse-card').forEach(c=>c.classList.remove('selected'));
    card.classList.add('selected');
    updateLock();
  }

  function updateLock(){
    const p = state.players[state.current];
    const bet = Number(el('bet-amount').value||0);
    el('lock-pick').disabled = !(p.horseIndex!=null && bet>0 && bet<=p.balance);
  }

  el('bet-amount').addEventListener('input', updateLock);
  document.querySelectorAll('[data-chip]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const v = btn.dataset.chip; const p = state.players[state.current];
      let bet = Number(el('bet-amount').value||0);
      bet = v==='ALL'? p.balance : Math.min(p.balance, bet + Number(v));
      el('bet-amount').value = bet; updateLock();
    })
  });

  el('lock-pick').addEventListener('click', ()=>{
    const p = state.players[state.current];
    p.bet = Number(el('bet-amount').value||0);
    p.betType = el('bet-type').value;
    state.picks.push({playerId:p.id, playerName:p.name, horseIndex:p.horseIndex, bet:p.bet, betType:p.betType});
    if(state.current < state.players.length-1){ state.current++; renderDraft(); el('bet-amount').value=''; document.querySelectorAll('.horse-card').forEach(c=>c.classList.remove('selected')); }
    else { startRace(); }
  });

  // --------- Race (straight line with drama) ---------
  function startRace(){
    el('status').textContent='Race'; show('race'); el('dock').hidden=true; el('next-race').hidden=true;
    const track = el('track'); track.innerHTML = '<div class="countdown" id="countdown"></div><div class="finish"></div>';

    // build lanes for all horses, highlight player picks
    const lanesCount = Math.min(NUM_LANES, state.horses.length);
    const pickByHorse = new Map(state.picks.map(p=>[p.horseIndex,p]));

    const lanes=[];
    for(let i=0;i<lanesCount;i++){
      const lane = document.createElement('div'); lane.className='lane'; track.appendChild(lane);
      const runner = document.createElement('div'); runner.className='runner';
      if(pickByHorse.has(i)) runner.classList.add('player');
      runner.innerHTML = state.horses[i].img +
        `<span class="name">${state.horses[i].name}</span>` +
        (pickByHorse.has(i)? `<span class="tag">${pickByHorse.get(i).playerName}</span>`:'' );
      lane.appendChild(runner);
      lanes.push({lane, runner});
    }

    // decide finish order weighted by 1/odds
    const pool = state.horses.map((h,i)=>({i,w:1/h.odds}));
    const order=[]; let sumW = pool.reduce((a,x)=>a+x.w,0);
    for(let k=0;k<lanesCount;k++){
      let r = Math.random()*sumW; let pickIndex=0;
      for(let j=0;j<pool.length;j++){ r-=pool[j].w; if(r<=0){ pickIndex=j; break; } }
      order.push(pool[pickIndex].i); sumW -= pool[pickIndex].w; pool.splice(pickIndex,1);
    }
    state.order = order;

    // countdown
    const cd = el('countdown');
    const seq = ['3','2','1','Go!'];
    let ci=0; cd.textContent=seq[ci];
    const cdInt = setInterval(()=>{ ci++; if(ci<seq.length){ cd.textContent=seq[ci]; } else { clearInterval(cdInt); cd.remove(); runRace(lanes, order); } }, 600);
  }

  function runRace(lanes, order){
    const start = performance.now();
    const announcer = el('announcer'); announcer.textContent = 'They are off...';

    // Precompute speed curves: keep pack close, reveal order late
    const laneProfiles = lanes.map((_,laneIndex)=>{
      const isWinner = order[0]===laneIndex;
      const base = 0.82 + Math.random()*0.05; // most finish just short visually
      const finishBonus = 0.18; // to cross line
      const surges = [0.35,0.55,0.78].map(t=> ({at:t, mag: 0.02 + Math.random()*0.03}));
      return {target: base + (isWinner?finishBonus:Math.random()*0.06), surges};
    });

    function ease(t){ return t<.5 ? 2*t*t : -1+(4-2*t)*t; }

    function tick(now){
      const elapsed = Math.min(RACE_DURATION, now-start);
      const t = elapsed/RACE_DURATION;
      const s = ease(t);

      lanes.forEach((L, i)=>{
        const p = laneProfiles[i];
        let progress = p.target * s;
        p.surges.forEach(su=>{ if(t>su.at) progress += (t-su.at)*su.mag; });
        progress = Math.min(1, progress);
        const maxX = L.lane.clientWidth - 96; // keep svg inside
        L.runner.style.transform = `translateX(${Math.max(8, progress*maxX)}px)`;
      });

      // simple ringside updates for drama
      if(t>0.25 && t<0.28) announcer.textContent = 'Early pace — they stay bunched.';
      else if(t>0.55 && t<0.58) announcer.textContent = 'Mid-race move from the outside.';
      else if(t>0.82 && t<0.85) announcer.textContent = 'Late kick — photo finish coming!';

      if(elapsed < RACE_DURATION){ requestAnimationFrame(tick); }
      else { finishRace(order); }
    }
    requestAnimationFrame(tick);
  }

  function finishRace(order){
    el('next-race').hidden=false;
    const first = order[0], second = order[1];

    // payouts
    const rows=[];
    state.players.forEach(p=>{
      const hi = p.horseIndex; if(hi==null) return;
      const h = state.horses[hi];
      const win = (p.betType==='win' && hi===first) || (p.betType==='place' && (hi===first || hi===second));
      const odds = p.betType==='win'? h.odds : h.placeOdds;
      const delta = win ? Math.floor(p.bet*odds) : -p.bet;
      p.balance += delta;
      rows.push({name:p.name, horse:h.name, bet:p.bet, betType:p.betType, odds, delta});
      // clear
      p.horseIndex=null; p.bet=0; p.betType='win';
    });

    const body = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div style="font-weight:700;margin-bottom:6px">Podium</div>
          <div class="sub">1. ${state.horses[first].name} (${state.horses[first].odds.toFixed(2)}x)<br>2. ${state.horses[second].name} (${state.horses[second].odds.toFixed(2)}x)</div>
        </div>
        <div>
          <table>
            <thead><tr><th>Player</th><th>Horse</th><th>Bet</th><th>Type</th><th>Odds</th><th>Δ</th></tr></thead>
            <tbody>
              ${rows.map(r=>`<tr><td>${r.name}</td><td>${r.horse}</td><td>${fmt(r.bet)}</td><td>${r.betType}</td><td>${r.odds.toFixed(2)}x</td><td style="color:${r.delta>=0?'var(--win)':'var(--loss)'}">${r.delta>=0?'+':''}${fmt(r.delta)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`;

    el('result-body').innerHTML = body;
    el('result-sub').textContent = 'Balances — ' + state.players.map(p=>`${p.name}: ${fmt(p.balance)}`).join(' • ');
    el('result-modal').showModal();
  }

  el('again').addEventListener('click',()=>{ el('result-modal').close(); startDraft(); });
  el('reset').addEventListener('click',()=>{ location.reload(); });
  el('next-race').addEventListener('click',()=>{ startDraft(); });

  function show(which){
    el('setup').hidden = which!=='setup';
    el('draft').hidden = which!=='draft';
    el('race').hidden  = which!=='race';
  }

  // Boot with two players default
  state.players = [
    {id:crypto.randomUUID(), name:'Player 1', balance:1000, betType:'win', bet:0, horseIndex:null},
    {id:crypto.randomUUID(), name:'Player 2', balance:1000, betType:'win', bet:0, horseIndex:null}
  ];
  renderSetup();
})();
</script></body>
</html>
