<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Finish — Multiplayer Horse Race</title>
  <style>
    :root{
      --navy:#0B1F2A; --cream:#FDF5D9; --red:#D43D3D;
      --ink:var(--cream); --paper:var(--navy); --accent:var(--red); --muted:#C1D6E3;
      --win:#31c48d; --loss:#f05252;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--paper)}
    header{padding:12px 16px;background:linear-gradient(180deg,#0b1f2a,#0b2536);border-bottom:1px solid #12344a;position:sticky;top:0;z-index:50;display:flex;flex-direction:column;gap:8px}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .status{font-variant-numeric:tabular-nums;color:var(--muted)}
    .players-bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .pill{display:flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:#0f2a3c;border:1px solid #16384d;font-size:14px}
    .pill .dot{width:10px;height:10px;border-radius:50%}
    .pill .bal{font-variant-numeric:tabular-nums;font-weight:800}

    .screen{padding:12px 12px 120px;max-width:980px;margin:0 auto}
    .section{font-size:12px;letter-spacing:.04em;color:var(--muted);text-transform:uppercase;margin:10px 2px}
    .row{display:flex;gap:8px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:10px}

    /* Buttons: light bg for contrast */
    .btn{padding:10px 14px;border:1px solid #e9dec2;border-radius:12px;background:var(--cream);color:var(--navy);cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(212,61,61,.28)}
    .btn.ghost{background:#f8f0d6;color:#0b1f2a}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    input[type="text"],input[type="number"],select{width:100%;padding:12px;border:1px solid #1a3a4f;border-radius:10px;background:#0f2433;color:var(--cream);font:inherit}
    .card{border:1px solid #153244;border-radius:16px;background:#0f1f2b;box-shadow:0 2px 16px rgba(0,0,0,.35)}

    /* Draft: turn order + banner */
    .turns{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .turn{display:flex;gap:6px;align-items:center;padding:6px 10px;border-radius:10px;border:1px solid #16384d;background:#0f2433;font-size:12px}
    .turn.active{outline:2px solid var(--accent)}
    .callout{position:sticky;top:60px;z-index:40;margin:6px 0;padding:12px;border-radius:14px;background:#102536;border:1px solid #16384d;display:flex;gap:10px;align-items:center}
    .callout .who{font-weight:800;font-size:16px}
    .callout .bal{font-variant-numeric:tabular-nums;font-weight:800;color:#ffe9a6}

    /* Draft grid made more readable */
    .horses{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){.horses{grid-template-columns:1fr 1fr}}
    .horse-card{position:relative;display:grid;grid-template-columns:72px 1fr auto;gap:12px;align-items:center;padding:14px}
    .horse-card.selected{outline:2px solid var(--accent)}
    .taken{position:absolute;top:8px;right:8px;font-size:12px;background:#5c1a1a;color:#fff;border-radius:8px;padding:3px 8px}
    .name-lg{font-weight:900;font-size:18px;letter-spacing:.2px}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:11px;border:1px solid #21465d;color:#e6f2f8;background:#0b2536;border-radius:999px;padding:2px 8px}
    .badge{font-weight:900;border:2px solid #e9dec2;border-radius:12px;padding:6px 10px;min-width:84px;text-align:center;background:#fdf5d9;color:#0b1f2a;font-size:16px}
    .sub{font-size:12px;color:var(--muted)}

    /* Bottom bar */
    .dock{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(11,31,42,.6),#0b1f2a);border-top:1px solid #143349;padding:10px 12px;z-index:60}
    .dock-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .summary{margin-left:auto;font-size:14px;background:#0f2433;border:1px solid #16384d;padding:10px 12px;border-radius:12px;font-weight:800}

    /* Straight track with scrolling */
    .track-wrap{border:1px solid #153244;border-radius:16px;background:linear-gradient(#0e2840 0 42%, #0b2536 42% 43%, #153b2d 43%);box-shadow:inset 0 6px 40px rgba(0,0,0,.35);padding:12px}
    .viewport{position:relative;overflow:hidden;border-radius:12px;background:linear-gradient(90deg,#1a3144,#122838)}
    .track{position:relative;height:calc(58px * 8 + 8px); width:3600px}
    .lane{position:relative;display:flex;align-items:center;height:58px;border-top:1px dashed rgba(255,255,255,.08)}
    .lane:first-child{border-top:none}
    .runner{position:absolute;left:8px;display:flex;align-items:center;gap:8px;transition:transform .08s linear}
    .runner .name{font-size:12px;padding:2px 8px;border-radius:999px;background:#0f2433;border:1px solid #16384d;color:var(--cream)}
    .runner .tag{font-size:11px;color:#fff;background:var(--accent);padding:2px 6px;border-radius:6px}
    .runner.player .name{border-color:var(--accent);box-shadow:0 0 0 2px rgba(212,61,61,.25)}
    .finish{position:absolute;left:3450px;top:0;bottom:0;width:10px;background:repeating-linear-gradient(180deg,#fff,#fff 8px,#222 8px,#222 16px);opacity:.95}

    /* Position markers for top 3 */
    .pos{font-size:11px;font-weight:700;padding:2px 6px;border-radius:8px;border:1px solid #1a3a4f;background:#0e2030;color:var(--cream)}
    .pos.p1{background:var(--accent);border-color:var(--accent)}
    .pos.p2{background:#d9c9a0;color:#1a1a1a;border-color:#d9c9a0}
    .pos.p3{background:#7aa1b8}

    /* Overlays */
    .countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:56px;color:#fff;text-shadow:0 2px 16px rgba(0,0,0,.55);pointer-events:none}
    .announcer{margin-top:8px;font-size:14px;color:var(--cream)}
    .leaderboard{margin-top:8px}
    .board{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
    .rank{width:26px;height:26px;border-radius:999px;background:#102a3b;display:flex;align-items:center;justify-content:center;border:1px solid #1a3a4f}

    dialog{border:none;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45);padding:16px;max-width:640px;background:#0f1f2b;color:var(--cream);border:1px solid #153244}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .turn-modal h2{margin:0 0 6px 0;font-size:20px}
    .turn-modal .big{font-size:32px;font-weight:900}
    .turn-modal .bal{font-variant-numeric:tabular-nums;color:#ffe9a6;font-weight:900}
    .turn-modal .row{justify-content:flex-end}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <strong style="color:var(--cream)">Photo Finish</strong>
      <div class="status" id="status">Setup</div>
    </div>
    <div class="players-bar" id="players-bar"></div>
  </header>

  <!-- Setup -->
  <main class="screen" id="setup">
    <div class="section">Add players</div>
    <div class="card" style="padding:12px">
      <div id="player-list" class="stack"></div>
      <div class="row">
        <input id="new-player" type="text" placeholder="Player name"/>
        <button class="btn" id="add-player">Add</button>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="sub">Starting balance</div>
        <input id="start-balance" type="number" value="1000" min="100" step="50" style="width:120px"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="start-draft" class="btn primary" disabled>Start draft</button>
    </div>
  </main>

  <!-- Draft -->
  <main class="screen" id="draft" hidden>
    <div class="section"><span id="turn-label">Draft</span></div>
    <div id="turns" class="turns"></div>

    <!-- Call player banner (sticky) -->
    <div class="callout" id="callout" hidden>
      <div class="dot" id="callout-dot" style="width:12px;height:12px;border-radius:50%"></div>
      <div class="who" id="callout-who"></div>
      <div class="sub">Balance:</div>
      <div class="bal" id="callout-bal"></div>
    </div>

    <div id="horse-grid" class="horses"></div>
    <p class="sub" id="fav-hint" style="margin-top:6px"></p>
  </main>

  <!-- Race -->
  <main class="screen" id="race" hidden>
    <div class="section">Race — Scrolling straight line (20s)</div>
    <div class="track-wrap">
      <div class="viewport" id="viewport">
        <div class="track" id="track">
          <div class="countdown" id="countdown"></div>
          <div class="finish"></div>
        </div>
      </div>
    </div>
    <div class="announcer" id="announcer"></div>
    <div class="leaderboard card" style="padding:10px" id="leaderboard" hidden>
      <div class="section" style="margin:0 0 6px 0">Live leaderboard</div>
      <div id="board" class="board"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="next-race" hidden>Next race</button>
    </div>
  </main>

  <!-- Bottom bet dock -->
  <div class="dock" id="dock" hidden>
    <div class="dock-row">
      <select id="bet-type" style="flex:0 0 160px">
        <option value="win">Win</option>
        <option value="place">Place (1st/2nd)</option>
      </select>
      <input id="bet-amount" type="number" min="1" placeholder="Bet amount" class="bet" style="flex:1"/>
      <button class="btn" data-chip="25">+25</button>
      <button class="btn" data-chip="50">+50</button>
      <button class="btn" data-chip="100">+100</button>
      <button class="btn" data-chip="500">+500</button>
      <button class="btn" data-chip="ALL">All-in</button>
      <button id="lock-pick" class="btn primary" disabled>Lock pick</button>
      <button id="back-setup" class="btn ghost">Players</button>
      <div id="bet-summary" class="summary">—</div>
    </div>
  </div>

  <!-- Turn modal (explicit call + balance before selection) -->
  <dialog id="turn-modal" class="turn-modal">
    <h2>It is your turn</h2>
    <div class="big" id="tm-name">Player</div>
    <div style="margin:6px 0 14px 0">Balance: <span class="bal" id="tm-bal">1,000</span></div>
    <div class="row">
      <button class="btn" id="tm-begin">Start selection</button>
    </div>
  </dialog>

  <!-- Results -->
  <dialog id="result-modal">
    <h3 id="result-title" style="margin:4px 0 8px">Results</h3>
    <div id="result-body" style="margin-bottom:12px"></div>
    <div class="sub" id="result-sub"></div>
    <div class="row" style="justify-content:flex-end;margin-top:14px">
      <button class="btn" id="again">Next race</button>
      <button class="btn" id="reset">Reset</button>
    </div>
  </dialog>

<script>
(function(){
  const NUM_LANES = 8;
  const RACE_DURATION = 20000; // 20s
  const PLACE_FACTOR = 0.55;

  const state = {
    players: [], // {id,name,balance,color,betType,bet,horseIndex}
    picks: [],   // per race
    horses: [],
    order: [],
    turnOrder: [], // indexes in random order
    turnPtr: 0,
    turnReady: false
  };

  const el = (id)=>document.getElementById(id);
  const qs = (s)=>document.querySelector(s);
  const fmt = (n)=>Number(n).toLocaleString(undefined,{maximumFractionDigits:0});

  // Utils
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
  function playerColor(i){ const h = Math.round((i*137.508) % 360); return `hsl(${h} 70% 60%)`; }

  // --------- Setup ---------
  function renderSetup(){
    el('status').textContent='Setup';
    const list = el('player-list'); list.innerHTML='';
    state.players.forEach((p,i)=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `<input type="text" value="${p.name}" data-i="${i}"/>
                       <span class="sub">${fmt(p.balance)} credits</span>
                       <button class=\"btn\" data-del=\"${i}\">Remove</button>`;
      row.querySelector('input').addEventListener('input', e=>{ p.name=e.target.value.trim(); updatePlayersBar(); });
      row.querySelector('[data-del]').addEventListener('click', ()=>{ state.players.splice(i,1); renderSetup(); updateStartDisabled(); updatePlayersBar(); });
      list.appendChild(row);
    });
    updateStartDisabled(); updatePlayersBar();
  }
  function updateStartDisabled(){ el('start-draft').disabled = state.players.length<2; }

  el('add-player').addEventListener('click', ()=>{
    const name = el('new-player').value.trim() || `Player ${state.players.length+1}`;
    const bal = Math.max(100, Number(el('start-balance').value||1000));
    const color = playerColor(state.players.length);
    state.players.push({id:crypto.randomUUID(), name, balance:bal, color, betType:'win', bet:0, horseIndex:null});
    el('new-player').value=''; renderSetup();
  });

  el('start-draft').addEventListener('click', ()=>{ startDraft(); });
  el('back-setup').addEventListener('click', ()=>{ show('setup'); });

  // --------- Draft ---------
  function startDraft(){
    state.picks=[]; state.turnOrder = shuffle([...Array(state.players.length).keys()]); state.turnPtr=0; state.turnReady=false;
    state.horses = generateHorses(Math.min(NUM_LANES, Math.max(state.players.length+2,6)));
    show('draft'); renderTurns(); renderDraft();
    el('dock').hidden=false; el('bet-amount').value=''; el('bet-type').value='win';
    updatePlayersBar(); updateBetSummary();
    openTurnGate();
  }

  function currentPlayer(){ return state.players[state.turnOrder[state.turnPtr]]; }

  function renderTurns(){
    const wrap = el('turns'); wrap.innerHTML='';
    state.turnOrder.forEach((pi,idx)=>{
      const p = state.players[pi];
      const chip = document.createElement('div'); chip.className='turn'+(idx===state.turnPtr?' active':'');
      chip.innerHTML = `<span class="dot" style="width:10px;height:10px;border-radius:50%;background:${p.color}"></span><strong>${p.name}</strong><span class="sub">Bal ${fmt(p.balance)}</span>`;
      wrap.appendChild(chip);
    });
  }

  // Gate modal + sticky banner
  function openTurnGate(){
    const p = currentPlayer(); state.turnReady=false;
    el('tm-name').textContent = p.name;
    el('tm-bal').textContent = fmt(p.balance);
    el('callout-who').textContent = `${p.name} is picking`;
    el('callout-bal').textContent = fmt(p.balance);
    el('callout-dot').style.background = p.color;
    el('callout').hidden = false;
    el('turn-modal').showModal();
  }

  el('tm-begin').addEventListener('click',()=>{
    state.turnReady=true; el('turn-modal').close();
    // focus bet input for quick entry
    setTimeout(()=>{ el('bet-amount').focus(); }, 50);
  });

  function generateHorses(n){
    const names = uniqueHorseNames(n);
    const colors = colorPalette(n);
    return names.map((name,i)=>{
      const speed = 60 + Math.random()*40;
      const stamina = 50 + Math.random()*50;
      const burst = 40 + Math.random()*60;
      const temper = 30 + Math.random()*70;
      const score = 0.5*speed + 0.3*stamina + 0.2*burst;
      const odds = Math.max(1.4, Math.round((1/((score)/(n*50)*0.9))*10)/10);
      return {name,color:colors[i],img:horseSVG(colors[i],i),attr:{speed,stamina,burst,temper},odds,placeOdds:Math.max(1.2,Math.round(odds*PLACE_FACTOR*10)/10)}
    });
  }

  function renderDraft(){
    el('status').textContent='Draft';
    const p = currentPlayer();
    qs('#turn-label').textContent = `${p.name}: pick your horse & bet`;

    const grid = el('horse-grid'); grid.innerHTML='';
    const favIdx = state.horses.map(h=>1/h.odds).indexOf(Math.max(...state.horses.map(h=>1/h.odds)));
    el('fav-hint').textContent = `Favorite: ${state.horses[favIdx].name} (${state.horses[favIdx].odds.toFixed(2)}x)`;

    state.horses.forEach((h,i)=>{
      const taken = state.picks.some(pk=>pk.horseIndex===i);
      const card = document.createElement('button');
      card.className='card horse-card'; card.type='button'; card.disabled = taken || !state.turnReady;
      card.innerHTML = `
        <div>${h.img}</div>
        <div>
          <div class="name-lg">${h.name}</div>
          <div class="chips">
            <span class="chip">Speed ${h.attr.speed|0}</span>
            <span class="chip">Stamina ${h.attr.stamina|0}</span>
            <span class="chip">Burst ${h.attr.burst|0}</span>
          </div>
        </div>
        <div>
          <div class="badge">${h.odds.toFixed(2)}x</div>
          <div class="sub" style="text-align:center">Place ${h.placeOdds.toFixed(2)}x</div>
        </div>
        <span class="taken" ${taken? '':'hidden'}>Selected</span>`;
      if(taken){
        const pick = state.picks.find(pk=>pk.horseIndex===i);
        if(pick) card.querySelector('.taken').textContent = `Selected by ${pick.playerName}`;
      }
      card.addEventListener('click',()=>selectHorse(i, card));
      grid.appendChild(card);
    });

    updateLock();
  }

  function selectHorse(i, card){
    if(!state.turnReady) return;
    const p = currentPlayer(); p.horseIndex = i;
    document.querySelectorAll('.horse-card').forEach(c=>c.classList.remove('selected'));
    card.classList.add('selected');
    updateBetSummary();
    updateLock();
  }

  function updateLock(){
    const p = currentPlayer();
    const bet = Number(el('bet-amount').value||0);
    el('lock-pick').disabled = !(state.turnReady && p?.horseIndex!=null && bet>0 && bet<=p.balance);
  }

  function updateBetSummary(){
    const p = currentPlayer(); if(!p){ el('bet-summary').textContent='—'; return; }
    const bet = Number(el('bet-amount').value||0);
    const left = Math.max(0, p.balance - bet);
    el('bet-summary').innerHTML = `<strong>${p.name}</strong> • Balance <strong>${fmt(p.balance)}</strong> • Bet <strong style="color:var(--accent)">${fmt(bet)}</strong> • Left <strong>${fmt(left)}</strong>`;
    renderTurns();
  }

  el('bet-amount').addEventListener('input', ()=>{ updateBetSummary(); updateLock(); });
  document.querySelectorAll('[data-chip]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const v = btn.dataset.chip; const p = currentPlayer(); if(!p) return;
      let bet = Number(el('bet-amount').value||0);
      bet = v==='ALL'? p.balance : Math.min(p.balance, bet + Number(v));
      el('bet-amount').value = bet; updateBetSummary(); updateLock();
    })
  });

  el('lock-pick').addEventListener('click', ()=>{
    const p = currentPlayer();
    p.bet = Number(el('bet-amount').value||0);
    p.betType = el('bet-type').value;
    state.picks.push({playerId:p.id, playerName:p.name, horseIndex:p.horseIndex, bet:p.bet, betType:p.betType});
    state.turnPtr++; state.turnReady=false;
    if(state.turnPtr < state.turnOrder.length){ el('bet-amount').value=''; renderTurns(); renderDraft(); updateBetSummary(); openTurnGate(); }
    else { startRace(); }
  });

  // --------- Race (scrolling straight line with lead changes) ---------
  function startRace(){
    el('status').textContent='Race'; show('race'); el('dock').hidden=true; el('next-race').hidden=true; el('leaderboard').hidden=false;
    const viewport = el('viewport'); const track = el('track'); track.innerHTML = '<div class="countdown" id="countdown"></div><div class="finish"></div>';

    const lanesCount = Math.min(NUM_LANES, state.horses.length);
    const pickByHorse = new Map(state.picks.map(p=>[p.horseIndex,p]));

    const lanes=[];
    for(let i=0;i<lanesCount;i++){
      const lane = document.createElement('div'); lane.className='lane'; track.appendChild(lane);
      const runner = document.createElement('div'); runner.className='runner'; if(pickByHorse.has(i)) runner.classList.add('player');
      runner.innerHTML = state.horses[i].img + `<span class="pos" hidden></span>` + `<span class="name">${state.horses[i].name}</span>` + (pickByHorse.has(i)? `<span class="tag">${pickByHorse.get(i).playerName}</span>`:'' );
      lane.appendChild(runner); lanes.push({lane, runner});
    }

    const weights = state.horses.map(h=>1/h.odds);
    const finalOrder = weights.map((w,i)=>({i,w})).sort((a,b)=>b.w-a.w).map(x=>x.i);
    state.order = finalOrder;

    const cd = el('countdown'); const seq = ['3','2','1','Go!']; let ci=0; cd.textContent=seq[ci];
    const cdInt = setInterval(()=>{ ci++; if(ci<seq.length){ cd.textContent=seq[ci]; } else { clearInterval(cdInt); cd.remove(); runRace(viewport, lanes, finalOrder); } }, 600);
  }

  function runRace(viewport, lanes, finalOrder){
    const start = performance.now();
    const announcer = el('announcer'); announcer.textContent = 'They are off...';
    const board = el('board');

    const trackLength = 3500; // px
    const profiles = lanes.map((_,i)=>{
      const h = state.horses[i];
      const base = 0.76 + Math.random()*0.08;
      const finishBonus = (finalOrder[0]===i? 0.24 : Math.random()*0.10);
      const surges = Array.from({length:8},()=>({at:Math.random()*0.97, mag: (h.attr.burst/550)*(0.5+Math.random()*1.0)})).sort((a,b)=>a.at-b.at);
      const fades = Array.from({length:5},()=>({at:Math.random()*0.92, mag: 0.02+Math.random()*0.04}));
      const wobble = (h.attr.temper/320);
      return {target:Math.min(1, base+finishBonus), surges, fades, wobble};
    });

    let lastLeader = -1; let leadSwitches = 0; let prevXs = new Array(lanes.length).fill(0);
    function ease(t){ return t<.5 ? 2*t*t : -1+(4-2*t)*t; }

    function tick(now){
      const elapsed = Math.min(RACE_DURATION, now-start);
      const t = elapsed/RACE_DURATION; const s = ease(t);

      const baseXs = lanes.map((Lane,i)=>{
        const p = profiles[i];
        let prog = p.target * s;
        p.surges.forEach(su=>{ if(t>su.at) prog += (t-su.at)*su.mag; });
        p.fades.forEach(fd=>{ if(t>fd.at) prog -= (t-fd.at)*fd.mag; });
        prog += Math.sin(t* (i+1) * 14) * p.wobble * 0.05;
        prog = Math.max(0, Math.min(1, prog));
        return 50 + prog * trackLength;
      });

      const maxPrevX = Math.max(...prevXs);
      const xs = baseXs.map((x,i)=>{
        const gap = Math.max(0, maxPrevX - prevXs[i]);
        const catchup = gap * 0.12;
        return x + catchup;
      });

      xs.forEach((x, i)=>{ lanes[i].runner.style.transform = `translateX(${x}px)`; });

      const order = xs.map((x,i)=>({i,x})).sort((a,b)=>b.x-a.x).map(o=>o.i);

      for(let i=0;i<lanes.length;i++){
        const posEl = lanes[i].runner.querySelector('.pos');
        posEl.hidden = true; lanes[i].runner.classList.remove('lead1','lead2','lead3');
      }
      [0,1,2].forEach(rank=>{
        const idx = order[rank]; if(idx==null) return;
        const posEl = lanes[idx].runner.querySelector('.pos');
        posEl.hidden = false; posEl.textContent = rank===0?'1st':rank===1?'2nd':'3rd';
        posEl.className = 'pos ' + (rank===0?'p1':rank===1?'p2':'p3');
      });

      const leader = order[0];
      if(leader!==lastLeader){ if(lastLeader!==-1) leadSwitches++; lastLeader = leader; announcer.textContent = `${state.horses[leader].name} takes the lead!`; }

      const maxX = xs[leader];
      const viewCenter = Math.max(0, maxX - (el('viewport').clientWidth*0.6));
      el('viewport').scrollTo({left:viewCenter, behavior:'auto'});

      board.innerHTML = order.slice(0,5).map((idx,rank)=>{
        const pick = state.picks.find(p=>p.horseIndex===idx);
        return `<div class=\"rank\">${rank+1}</div><div>${state.horses[idx].name}${pick?` <span class=\"sub\">(${pick.playerName})</span>`:''}</div><div class=\"sub\">${Math.round(xs[idx])} px</div>`;
      }).join('');

      if(t>0.2 && t<0.23) announcer.textContent = 'They bunch at the quarter!';
      else if(t>0.48 && t<0.52) announcer.textContent = 'Pace quickens — moves on the outside!';
      else if(t>0.8 && t<0.84) announcer.textContent = 'Final drive — who has the kick?';

      prevXs = xs;
      if(elapsed < RACE_DURATION){ requestAnimationFrame(tick); }
      else { announcer.textContent = `Photo finish! Lead changes: ${leadSwitches}`; finishRace(order.map(o=>o)); }
    }
    requestAnimationFrame(tick);
  }

  function finishRace(order){
    el('next-race').hidden=false;
    const first = order[0], second = order[1];

    const rows=[];
    state.players.forEach(p=>{
      const hi = p.horseIndex; if(hi==null) return;
      const h = state.horses[hi];
      const win = (p.betType==='win' && hi===first) || (p.betType==='place' && (hi===first || hi===second));
      const odds = p.betType==='win'? h.odds : h.placeOdds;
      const delta = win ? Math.floor(p.bet*odds) : -p.bet;
      p.balance += delta; rows.push({name:p.name, horse:h.name, bet:p.bet, betType:p.betType, odds, delta});
      p.horseIndex=null; p.bet=0; p.betType='win';
    });
    updatePlayersBar();

    const body = `
      <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:12px\">
        <div>
          <div style=\"font-weight:700;margin-bottom:6px\">Podium</div>
          <div class=\"sub\">1. ${state.horses[first].name} (${state.horses[first].odds.toFixed(2)}x)<br>2. ${state.horses[second].name} (${state.horses[second].odds.toFixed(2)}x)</div>
        </div>
        <div>
          <table>
            <thead><tr><th>Player</th><th>Horse</th><th>Bet</th><th>Type</th><th>Odds</th><th>Δ</th></tr></thead>
            <tbody>
              ${rows.map(r=>`<tr><td>${r.name}</td><td>${r.horse}</td><td>${fmt(r.bet)}</td><td>${r.betType}</td><td>${r.odds.toFixed(2)}x</td><td style=\"color:${r.delta>=0?'var(--win)':'var(--loss)'}\">${r.delta>=0?'+':''}${fmt(r.delta)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>`;

    el('result-body').innerHTML = body;
    el('result-sub').textContent = 'Balances — ' + state.players.map(p=>`${p.name}: ${fmt(p.balance)}`).join(' • ');
    el('result-modal').showModal();
  }

  el('again').addEventListener('click',()=>{ el('result-modal').close(); startDraft(); });
  el('reset').addEventListener('click',()=>{ location.reload(); });
  el('next-race').addEventListener('click',()=>{ startDraft(); });

  function show(which){
    el('setup').hidden = which!=='setup';
    el('draft').hidden = which!=='draft';
    el('race').hidden  = which!=='race';
  }

  // --------- Names helpers ---------
  const TITLES=["Sir","Lady","Captain","Saint","Baron","Count","Duke","Doctor","General","Mister","Queen","King","Chief","Major","El","La"];
  const ADJ=["Midnight","Lucky","Crimson","Silver","Velvet","Rapid","Quiet","Neon","Maple","Royal","Rocket","Golden","Storm","River","Cinder","Icy","Amber","Shadow","Copper","Brave","Blue","Scarlet","Ivory","Turbo","Jet","Mellow","Northern","Western","Urban","Wild","Bold","Spry","Swift","Gilded","Rusty","Misty","Solar","Lunar","Pepper","Noble","Bright","Nimble","Prime","Verdant","Granite","Iron","Maritime","Sable","Ruby"];
  const NOUN=["Comet","Whisper","Dash","Valor","Charm","Rider","Phantom","Ember","Voyager","Blaze","Echo","Tempo","Spirit","Horizon","Mirage","Thunder","Quasar","Bandit","Biscuit","Falcon","Clover","Nova","Ranger","Marble","Nimbus","Hustle","Rebel","Monarch","Harbor","Zephyr","Harrier","Beacon","Strider","Oracle","Signal","Pioneer","Vector","Summit","Caper","Riddle","Cipher","Pilot","Anchor"];

  function uniqueHorseNames(n){
    const t = shuffle([...TITLES]);
    const a = shuffle([...ADJ]);
    const b = shuffle([...NOUN]);
    const names=[]; let ti=0, ai=0, bi=0;
    for(let i=0;i<n;i++){
      const useTitle = Math.random()<0.35 && ti<t.length;
      const title = useTitle ? t[ti++]+' ' : '';
      const adj = a[ai++] || `Unique${i}`;
      const noun = b[bi++] || `Name${i}`;
      names.push((title+adj+' '+noun).trim());
    }
    return names;
  }

  function colorPalette(n){
    const cols=[]; const s=70,l=55;
    for(let i=0;i<n;i++){
      const h = Math.round((360/n)*i + Math.random()*8) % 360;
      cols.push(`hsl(${h} ${s}% ${l}%)`);
    }
    return cols;
  }

  function horseSVG(color, cloth){
    const pattern = [
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><path d="M-4 -8 h26" stroke="#222"/>',
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><circle cx="9" cy="-9" r="4" fill="#222"/>',
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><path d="M-4 -14 l26 14" stroke="#222"/>',
      '<rect x="-4" y="-16" width="26" height="14" rx="3" fill="#fff" stroke="#222"/><path d="M-4 -12 h26" stroke="#222"/><path d="M-4 -10 h26" stroke="#222"/>'
    ][cloth%4];
    return `<?xml version="1.0"?><svg width="64" height="46" viewBox="0 0 140 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <g fill="${color}" stroke="#222" stroke-width="2">
        <ellipse cx="60" cy="60" rx="36" ry="22"/>
        <circle cx="100" cy="58" r="16"/>
        <path d="M108 46 l18 -18 l8 8 l-12 14 z"/>
        <circle cx="112" cy="54" r="2" fill="#000"/>
        <rect x="20" y="70" width="14" height="18" rx="3"/>
        <rect x="58" y="72" width="14" height="18" rx="3"/>
        <rect x="94" y="72" width="14" height="18" rx="3"/>
      </g>
      <g transform="translate(86,76)" stroke="#222">${pattern}</g>
    </svg>`
  }

  // --------- Race payout & results ---------
  function updatePlayersBar(){
    const bar = document.getElementById('players-bar');
    bar.innerHTML = (state.players||[]).map(p=>`<span class=\"pill\"><span class=\"dot\" style=\"background:${p.color}\"></span><strong>${p.name}</strong><span class=\"bal\">${fmt(p.balance)}</span></span>`).join('');
  }

  // Boot
  state.players = [
    {id:crypto.randomUUID(), name:'Player 1', balance:1000, color:playerColor(0), betType:'win', bet:0, horseIndex:null},
    {id:crypto.randomUUID(), name:'Player 2', balance:1000, color:playerColor(1), betType:'win', bet:0, horseIndex:null}
  ];
  renderSetup();
})();
</script>
</body>
</html>
